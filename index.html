<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance Invoicer</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- 2. React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 3. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Firebase (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <!-- 5. Chart.js (For Analytics) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- 6. html2pdf (For PDF Generation) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- 7. EmailJS (For Email Automation) -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        /* Hide scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            .print-container { box-shadow: none; margin: 0; width: 100%; max-width: none; }
        }
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex; justify-content: center; align-items: center;
            z-index: 50;
        }
        /* Custom Scrollbar for dropdowns */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans h-screen overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        // --- ICONS ---
        const Icons = {
            Plus: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Trash2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Printer: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>,
            Save: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            FileText: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>,
            ChevronLeft: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>,
            LayoutDashboard: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>,
            Wrench: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>,
            Hammer: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 12-8.5 8.5c-.83.83-2.17.83-3 0 0 0 0 0 0 0a2.12 2.12 0 0 1 0-3L12 9"/><path d="M17.64 15 22 10.64"/><path d="m20.91 11.7-1.25-1.25c-.6-.6-.93-1.4-.93-2.25V7.86c0-.55-.45-1-1-1H14c-.55 0-1 .45-1 1v3.8c0 .85-.34 1.66-.93 2.25L10.82 15"/></svg>,
            User: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            MapPin: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>,
            CheckCircle: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            Clock: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            AlertCircle: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
            Search: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            CreditCard: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></svg>,
            AlignLeft: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="21" x2="3" y1="6" y2="6"/><line x1="15" x2="3" y1="12" y2="12"/><line x1="17" x2="3" y1="18" y2="18"/></svg>,
            FileAxis3d: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="m8 13 4 4"/><path d="m8 17 4-4"/></svg>,
            ArrowRight: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>,
            Users: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            Settings: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Mail: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>,
            Building: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="16" height="20" x="4" y="2" rx="2" ry="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M12 6h.01"/><path d="M12 10h.01"/><path d="M12 14h.01"/><path d="M16 10h.01"/><path d="M16 14h.01"/><path d="M8 10h.01"/><path d="M8 14h.01"/></svg>,
            Phone: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>,
            Bell: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>,
            Copy: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>,
            Filter: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>,
            ChevronDown: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg>,
            Download: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            DollarSign: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>,
            MoreVertical: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>,
            Bank: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 21h18"/><path d="M5 21v-7"/><path d="M19 21v-7"/><path d="M10 9L3 21"/><path d="M14 9l7 12"/><rect x="2" y="3" width="20" height="5"/><path d="M12 12v9"/></svg>,
            Upload: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            MailWarning: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 10.5V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v12c0 1.1.9 2 2 2h12.5"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/><path d="M20 14v4"/><path d="M20 22v.01"/></svg>,
            Image: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>,
            Link: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>,
            Send: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" x2="11" y1="2" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
            Edit: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
            X: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Box: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" x2="12" y1="22.08" y2="12"/></svg>,
            PenTool: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 19 7-7 3 3-7 7-3-3z"/><path d="m18 13-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="m2 2 7.586 7.586"/><circle cx="11" cy="11" r="2"/></svg>,
            Calendar: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>,
            ArrowUp: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m18 15-6-6-6 6"/></svg>,
            ArrowDown: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg>
        };

        const { useState, useEffect, useMemo, useRef } = React;

        // --- FIREBASE CONFIGURATION (SECURE LOCAL STORAGE) ---
        let firebaseConfig = null;
        let app, auth, db, storage;
        
        if (typeof __firebase_config !== 'undefined') {
            try {
                firebaseConfig = JSON.parse(__firebase_config);
            } catch (e) { console.error(e); }
        } 
        
        if (!firebaseConfig) {
            const savedConfig = localStorage.getItem('maintenance_invoicer_firebase_config');
            if (savedConfig) {
                try {
                    firebaseConfig = JSON.parse(savedConfig);
                } catch(e) { console.error("Invalid saved config", e); }
            }
        }

        const isConfigured = !!firebaseConfig;
        
        if (isConfigured) {
            try {
                if (!firebase.apps.length) {
                    app = firebase.initializeApp(firebaseConfig);
                } else {
                    app = firebase.app();
                }
                auth = firebase.auth();
                db = firebase.firestore();
                storage = firebase.storage();
            } catch(e) {
                console.error("Firebase Init Error:", e);
            }
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'maintenance-invoicer';

        const getCollectionRef = (collectionName) => {
            if (!db) return null;
            return db.collection('artifacts').doc(appId).collection('public').doc('data').collection(collectionName);
        };

        const timeoutPromise = (ms, promise) => {
            return new Promise((resolve, reject) => {
                const timeoutId = setTimeout(() => {
                    reject(new Error("Operation timed out. Please check your internet connection or if the Firestore API is enabled."));
                }, ms);
                promise.then(
                    (res) => { clearTimeout(timeoutId); resolve(res); },
                    (err) => { clearTimeout(timeoutId); reject(err); }
                );
            });
        };

        // --- CONSTANTS ---
        const PREDEFINED_SERVICES_DEFAULTS = [
            { id: 'custom', label: 'Custom Item...', description: '', rate: 0 },
            { id: 'callout', label: 'Call Out Fee (Standard)', description: 'Standard Call Out Fee', rate: 550 },
            { id: 'callout_ah', label: 'Call Out Fee (After Hours)', description: 'Emergency / After Hours Call Out', rate: 850 },
            { id: 'labor_gen', label: 'Labour (General)', description: 'General Maintenance Labour', rate: 450 },
            { id: 'labor_special', label: 'Labour (Specialist)', description: 'Specialist / Technical Labour', rate: 650 },
            { id: 'fuel', label: 'Fuel / Travel Costs', description: 'Travel & Fuel Charges', rate: 8.50 },
            { id: 'consumables', label: 'Small Consumables', description: 'Fixings, Sealants & Consumables', rate: 150 },
        ];

        const generateId = () => Math.random().toString(36).substr(2, 9);

        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-ZA', { style: 'currency', currency: 'ZAR', minimumFractionDigits: 2 }).format(amount);
        };

        const formatDate = (dateString) => {
            if (!dateString) return '';
            const parts = dateString.split('-');
            if (parts.length === 3) {
                const d = new Date(parts[0], parts[1] - 1, parts[2]);
                return d.toLocaleDateString('en-ZA', { year: 'numeric', month: 'long', day: 'numeric' });
            }
            return new Date(dateString).toLocaleDateString('en-ZA', { year: 'numeric', month: 'long', day: 'numeric' });
        };

        const calculateTotals = (items, discountVal, discountType, taxRate, deposit = 0, expenses = []) => {
            const subtotal = items.reduce((acc, item) => acc + (item.quantity * item.rate), 0);
            const totalCost = items.reduce((acc, item) => acc + (item.quantity * (item.cost || 0)), 0);
            const totalExpenses = expenses.reduce((acc, exp) => acc + (Number(exp.amount) || 0), 0);
            
            let discountAmount = discountType === 'percent' ? subtotal * (discountVal / 100) : discountVal;
            discountAmount = Math.min(discountAmount, subtotal);
            const subtotalAfterDiscount = subtotal - discountAmount;
            const taxAmount = subtotalAfterDiscount * (taxRate / 100);
            const total = subtotalAfterDiscount + taxAmount;
            
            // Profit = (Revenue - Discount - Tax (passed through)) - (Item Costs + Expenses)
            const profit = subtotalAfterDiscount - totalCost - totalExpenses;
            const margin = subtotalAfterDiscount > 0 ? (profit / subtotalAfterDiscount) * 100 : 0;

            return { subtotal, discountAmount, taxAmount, total, balanceDue: total - deposit, depositRequired60: total * 0.60, totalCost, totalExpenses, profit, margin };
        };

        // --- COMPONENTS ---
        const Button = ({ children, variant = 'primary', className, ...props }) => {
            const variants = {
                primary: "bg-blue-600 text-white hover:bg-blue-700 shadow-sm",
                secondary: "bg-white text-slate-700 border border-slate-300 hover:bg-slate-50 shadow-sm",
                danger: "bg-red-50 text-red-600 border border-red-200 hover:bg-red-100",
                ghost: "text-slate-600 hover:bg-slate-100",
                success: "bg-emerald-600 text-white hover:bg-emerald-700 shadow-sm",
                warning: "bg-amber-500 text-white hover:bg-amber-600 shadow-sm",
            };
            return <button className={`px-4 py-2 rounded-lg font-medium transition-all flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed ${variants[variant]} ${className || ''}`} {...props}>{children}</button>;
        };

        const Input = ({ label, error, className, ...props }) => (
            <div className={`flex flex-col gap-1.5 ${className || ''}`}>
                {label && <label className="text-sm font-semibold text-slate-700">{label}</label>}
                <input className={`px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all ${error ? "border-red-300 bg-red-50" : "border-slate-300 bg-white"}`} {...props} />
            </div>
        );

        const Badge = ({ status }) => {
            const styles = {
                Draft: "bg-slate-100 text-slate-600 border-slate-200", Quote: "bg-indigo-50 text-indigo-700 border-indigo-200",
                Pending: "bg-amber-50 text-amber-700 border-amber-200", Paid: "bg-emerald-50 text-emerald-700 border-emerald-200",
                Overdue: "bg-red-50 text-red-700 border-red-200", Deposit: "bg-purple-50 text-purple-700 border-purple-200",
            };
            const icons = { Draft: Icons.FileText, Quote: Icons.FileAxis3d, Pending: Icons.Clock, Paid: Icons.CheckCircle, Overdue: Icons.AlertCircle, Deposit: Icons.CreditCard };
            const IconComp = icons[status] || Icons.FileText;
            return <span className={`px-2.5 py-0.5 rounded-full text-xs font-medium border flex items-center gap-1.5 w-fit ${styles[status] || styles.Draft}`}><IconComp width="12" height="12" />{status}</span>;
        };

        const ClientSelect = ({ clients, value, onSelect }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [search, setSearch] = useState('');
            const wrapperRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [wrapperRef]);

            const filteredClients = clients.filter(c => 
                c.name.toLowerCase().includes(search.toLowerCase())
            );

            return (
                <div className="relative" ref={wrapperRef}>
                    <div 
                        className="w-full p-2 border rounded bg-white flex justify-between items-center cursor-pointer"
                        onClick={() => setIsOpen(!isOpen)}
                    >
                        <span className={value ? "text-slate-900" : "text-slate-400"}>
                            {value || "Select a Client..."}
                        </span>
                        <Icons.ChevronDown className="w-4 h-4 text-slate-400"/>
                    </div>
                    
                    {isOpen && (
                        <div className="absolute z-10 w-full mt-1 bg-white border rounded-lg shadow-lg max-h-60 overflow-hidden flex flex-col">
                            <div className="p-2 border-b">
                                <input 
                                    className="w-full p-1 border rounded text-sm focus:outline-none focus:border-blue-500"
                                    placeholder="Search..."
                                    value={search}
                                    onChange={(e) => setSearch(e.target.value)}
                                    autoFocus
                                />
                            </div>
                            <div className="overflow-y-auto custom-scroll flex-1">
                                {filteredClients.length === 0 && (
                                    <div className="p-3 text-sm text-slate-400 text-center">No clients found</div>
                                )}
                                {filteredClients.map(client => (
                                    <div 
                                        key={client.id}
                                        className="p-3 text-sm hover:bg-slate-50 cursor-pointer border-b last:border-0"
                                        onClick={() => {
                                            onSelect(client);
                                            setIsOpen(false);
                                            setSearch('');
                                        }}
                                    >
                                        <div className="font-medium text-slate-800">{client.name}</div>
                                        {client.email && <div className="text-xs text-slate-500">{client.email}</div>}
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- CALENDAR VIEW COMPONENT ---
        const CalendarView = ({ invoices, onSelectInvoice }) => {
            const [currentDate, setCurrentDate] = useState(new Date());
            
            const getDaysInMonth = (date) => {
                const year = date.getFullYear();
                const month = date.getMonth();
                const days = new Date(year, month + 1, 0).getDate();
                const firstDay = new Date(year, month, 1).getDay(); // 0 is Sunday
                return { days, firstDay };
            };

            const { days, firstDay } = getDaysInMonth(currentDate);
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

            const nextMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1));
            const prevMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1));

            const renderCalendar = () => {
                const dayElements = [];
                // Padding for empty days at start
                for (let i = 0; i < firstDay; i++) {
                    dayElements.push(<div key={`empty-${i}`} className="h-24 bg-slate-50 border border-slate-100"></div>);
                }

                // Days
                for (let d = 1; d <= days; d++) {
                    const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    const daysInvoices = invoices.filter(inv => inv.dueDate === dateStr);
                    
                    dayElements.push(
                        <div key={d} className="h-24 border border-slate-200 bg-white p-1 overflow-hidden relative group hover:border-blue-400 transition-colors">
                            <span className={`text-sm font-bold ${new Date().toDateString() === new Date(currentDate.getFullYear(), currentDate.getMonth(), d).toDateString() ? 'bg-blue-600 text-white px-1.5 rounded-full' : 'text-slate-700'}`}>{d}</span>
                            <div className="mt-1 space-y-1 overflow-y-auto max-h-[70px] no-scrollbar">
                                {daysInvoices.map(inv => {
                                    let colorClass = 'bg-slate-100 text-slate-600';
                                    if(inv.status === 'Quote') colorClass = 'bg-indigo-100 text-indigo-700';
                                    if(inv.status === 'Pending') colorClass = 'bg-amber-100 text-amber-700';
                                    if(inv.status === 'Paid') colorClass = 'bg-emerald-100 text-emerald-700';
                                    if(inv.status === 'Overdue') colorClass = 'bg-red-100 text-red-700';
                                    
                                    return (
                                        <div key={inv.id} onClick={() => onSelectInvoice(inv)} className={`text-[10px] px-1 py-0.5 rounded truncate cursor-pointer hover:opacity-80 ${colorClass}`}>
                                            {inv.clientName}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    );
                }
                return dayElements;
            };

            return (
                <div className="bg-white rounded-xl shadow-sm border p-6">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl font-bold text-slate-800">{monthNames[currentDate.getMonth()]} {currentDate.getFullYear()}</h2>
                        <div className="flex gap-2">
                            <Button variant="secondary" onClick={prevMonth}><Icons.ChevronLeft className="w-4 h-4"/></Button>
                            <Button variant="secondary" onClick={() => setCurrentDate(new Date())}>Today</Button>
                            <Button variant="secondary" onClick={nextMonth}><Icons.ArrowRight className="w-4 h-4"/></Button>
                        </div>
                    </div>
                    <div className="grid grid-cols-7 gap-px bg-slate-200 border border-slate-200 rounded-lg overflow-hidden">
                        {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
                            <div key={day} className="bg-slate-50 p-2 text-center text-xs font-bold text-slate-500 uppercase">{day}</div>
                        ))}
                        {renderCalendar()}
                    </div>
                </div>
            );
        };

        const RevenueChart = ({ invoices }) => {
            const chartRef = useRef(null);
            const canvasRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current) return;
                const months = [];
                const revenueData = [];
                const profitData = [];
                const today = new Date();
                for (let i = 5; i >= 0; i--) {
                    const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                    const monthKey = d.toLocaleString('default', { month: 'short', year: '2-digit' });
                    months.push(monthKey);
                    const monthlyInvoices = invoices.filter(inv => {
                        if (inv.status === 'Quote' || inv.status === 'Draft') return false;
                        const invDate = new Date(inv.date);
                        return invDate.getMonth() === d.getMonth() && invDate.getFullYear() === d.getFullYear();
                    });
                    const rev = monthlyInvoices.reduce((sum, inv) => sum + (inv.subtotal || 0), 0);
                    // Update Profit Calc to include expenses
                    const profit = monthlyInvoices.reduce((sum, inv) => {
                        const cost = (inv.items || []).reduce((c, item) => c + (item.quantity * (item.cost || 0)), 0);
                        const exp = (inv.expenses || []).reduce((e, item) => e + (Number(item.amount) || 0), 0);
                        return sum + ((inv.subtotal || 0) - cost - exp);
                    }, 0);
                    revenueData.push(rev);
                    profitData.push(profit);
                }
                if (chartRef.current) chartRef.current.destroy();
                chartRef.current = new Chart(canvasRef.current, {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [
                            { label: 'Revenue', data: revenueData, backgroundColor: '#3b82f6', borderRadius: 4 },
                            { label: 'Net Profit', data: profitData, backgroundColor: '#10b981', borderRadius: 4 }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } },
                        scales: { y: { beginAtZero: true, grid: { color: '#f1f5f9' } }, x: { grid: { display: false } } }
                    }
                });
                return () => { if(chartRef.current) chartRef.current.destroy(); };
            }, [invoices]);
            return <canvas ref={canvasRef} />;
        };

        // --- SIGNATURE PAD COMPONENT ---
        const SignatureModal = ({ isOpen, onClose, onSave }) => {
            const canvasRef = useRef(null);
            const [isDrawing, setIsDrawing] = useState(false);

            if (!isOpen) return null;

            const startDrawing = (e) => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                ctx.beginPath();
                ctx.moveTo(
                    e.nativeEvent.offsetX || e.touches[0].clientX - canvas.getBoundingClientRect().left,
                    e.nativeEvent.offsetY || e.touches[0].clientY - canvas.getBoundingClientRect().top
                );
                setIsDrawing(true);
            };

            const draw = (e) => {
                if (!isDrawing) return;
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                ctx.lineTo(
                    e.nativeEvent.offsetX || e.touches[0].clientX - canvas.getBoundingClientRect().left,
                    e.nativeEvent.offsetY || e.touches[0].clientY - canvas.getBoundingClientRect().top
                );
                ctx.stroke();
            };

            const endDrawing = () => {
                setIsDrawing(false);
            };

            const clear = () => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            };

            const save = () => {
                const canvas = canvasRef.current;
                const dataUrl = canvas.toDataURL(); // Base64 png
                onSave(dataUrl);
            };

            return (
                <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[150] animate-fade-in backdrop-blur-sm">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 mx-4">
                        <h3 className="font-bold text-lg mb-4 text-slate-800">Client Signature</h3>
                        <div className="border-2 border-slate-300 rounded-lg overflow-hidden touch-none bg-slate-50">
                            <canvas 
                                ref={canvasRef}
                                width={500}
                                height={200}
                                className="w-full h-48 cursor-crosshair"
                                onMouseDown={startDrawing}
                                onMouseMove={draw}
                                onMouseUp={endDrawing}
                                onMouseLeave={endDrawing}
                                onTouchStart={startDrawing}
                                onTouchMove={draw}
                                onTouchEnd={endDrawing}
                            />
                        </div>
                        <p className="text-xs text-slate-400 mt-2 mb-4 text-center">Sign above using your finger or mouse.</p>
                        <div className="flex justify-between">
                            <Button variant="ghost" onClick={clear}>Clear</Button>
                            <div className="flex gap-2">
                                <Button variant="secondary" onClick={onClose}>Cancel</Button>
                                <Button onClick={save}>Save Signature</Button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const BatchReminderModal = ({ isOpen, onClose, overdueInvoices, settings, showToast, sendEmail }) => {
            if (!isOpen) return null;
            const [sentIds, setSentIds] = useState([]);
            const [sendingIds, setSendingIds] = useState([]);

            const handleAutoRemind = async (inv) => {
                const daysOverdue = Math.ceil((new Date() - new Date(inv.dueDate)) / (1000 * 60 * 60 * 24));
                const subject = `Overdue Payment: ${inv.number} (${daysOverdue} Days Late)`;
                const body = `Dear ${inv.clientName},\n\nThis is a friendly reminder that invoice ${inv.number} is overdue by ${daysOverdue} days.\n\nAmount Due: ${formatCurrency(inv.balanceDue || inv.total)}\nDue Date: ${formatDate(inv.dueDate)}\n\nPlease arrange payment at your earliest convenience.\n\nRegards,\n${settings?.companyName || 'Accounts'}`;
                
                if (settings?.emailjsServiceId && settings?.emailjsTemplateId && settings?.emailjsPublicKey) {
                    setSendingIds(prev => [...prev, inv.id]);
                    try {
                        await sendEmail({
                            to_email: inv.clientEmail,
                            to_name: inv.clientName,
                            message: body,
                            subject: subject,
                            reply_to: settings.companyEmail
                        });
                        if(!sentIds.includes(inv.id)) setSentIds(prev => [...prev, inv.id]);
                        showToast(`Reminder sent to ${inv.clientName}`, "success");
                    } catch (err) {
                        console.error("Auto-send failed:", err);
                        showToast(`Failed to auto-send to ${inv.clientName}. Opening mail client...`, "error");
                        window.location.href = `mailto:${inv.clientEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                    } finally {
                        setSendingIds(prev => prev.filter(id => id !== inv.id));
                    }
                } else {
                    window.location.href = `mailto:${inv.clientEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                    if(!sentIds.includes(inv.id)) setSentIds(prev => [...prev, inv.id]);
                }
            };

            return (
                <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[100] animate-fade-in backdrop-blur-sm">
                    <div className="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[85vh] flex flex-col animate-slide-up">
                        <div className="p-6 border-b flex justify-between items-center bg-indigo-50 rounded-t-xl">
                            <div className="flex items-center gap-3">
                                <div className="bg-white p-2 rounded-lg shadow-sm text-indigo-600">
                                    <Icons.MailWarning className="w-6 h-6" />
                                </div>
                                <div>
                                    <h3 className="font-bold text-xl text-indigo-900">Monday Morning Reminders</h3>
                                    <p className="text-sm text-indigo-600">Review and send overdue notices.</p>
                                </div>
                            </div>
                            <button onClick={onClose} className="text-indigo-400 hover:text-indigo-700">
                                <Icons.X className="w-6 h-6" />
                            </button>
                        </div>
                        
                        <div className="p-6 overflow-y-auto custom-scroll flex-1 space-y-4">
                             {overdueInvoices.length === 0 ? (
                                <div className="text-center py-10 text-slate-500">
                                    <Icons.CheckCircle className="w-12 h-12 mx-auto mb-3 text-emerald-400"/>
                                    <p>All caught up! No overdue invoices found.</p>
                                </div>
                             ) : (
                                overdueInvoices.map(inv => {
                                    const isSent = sentIds.includes(inv.id);
                                    const isSending = sendingIds.includes(inv.id);
                                    const daysOverdue = Math.ceil((new Date() - new Date(inv.dueDate)) / (1000 * 60 * 60 * 24));
                                    const hasEmailJS = settings?.emailjsServiceId && settings?.emailjsTemplateId;
                                    
                                    return (
                                        <div key={inv.id} className={`flex items-center justify-between p-4 border rounded-lg transition-all ${isSent ? 'bg-emerald-50 border-emerald-100 opacity-75' : 'hover:bg-slate-50 border-slate-200'}`}>
                                            <div>
                                                <div className="flex items-center gap-2">
                                                    <span className="font-bold text-slate-800">{inv.clientName}</span>
                                                    <span className="text-xs bg-slate-100 px-2 py-0.5 rounded text-slate-500">{inv.number}</span>
                                                </div>
                                                <div className="text-sm text-slate-500 mt-1">
                                                    <span className="text-red-600 font-medium">{daysOverdue} Days Late</span> â€¢ Due: {formatDate(inv.dueDate)}
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-4">
                                                <div className="text-right">
                                                    <div className="font-bold text-slate-800">{formatCurrency(inv.balanceDue || inv.total)}</div>
                                                </div>
                                                <Button 
                                                    variant={isSent ? "success" : (hasEmailJS ? "primary" : "secondary")} 
                                                    onClick={() => handleAutoRemind(inv)}
                                                    disabled={isSent || isSending}
                                                    className="w-36 justify-center"
                                                >
                                                    {isSending ? (
                                                        <span className="animate-pulse">Sending...</span>
                                                    ) : isSent ? (
                                                        <>Sent <Icons.CheckCircle className="w-3 h-3 ml-1"/></>
                                                    ) : (
                                                        <>{hasEmailJS ? 'Auto-Send' : 'Email App'} <Icons.Send className="w-3 h-3 ml-1"/></>
                                                    )}
                                                </Button>
                                            </div>
                                        </div>
                                    );
                                })
                             )}
                        </div>

                        <div className="p-4 border-t bg-slate-50 rounded-b-xl flex justify-between items-center text-sm text-slate-500">
                            <div>{sentIds.length} / {overdueInvoices.length} Reminders Processed</div>
                            <Button onClick={onClose} variant="secondary">Close</Button>
                        </div>
                    </div>
                </div>
            );
        };

        const SetupScreen = ({ onSave }) => {
            const [configStr, setConfigStr] = useState('');
            const [error, setError] = useState('');

            const handleSave = () => {
                try {
                    let cleanStr = configStr.trim();
                    if (cleanStr.includes('=')) cleanStr = cleanStr.split('=')[1].trim();
                    if (cleanStr.endsWith(';')) cleanStr = cleanStr.slice(0, -1);

                    let parsed;
                    try {
                        parsed = JSON.parse(cleanStr);
                    } catch (jsonErr) {
                        try {
                            parsed = new Function("return " + cleanStr)();
                        } catch (jsErr) {
                            try {
                                const fixedStr = cleanStr.replace(/(['"])?([a-zA-Z0-9_]+)(['"])?:/g, '"$2":')
                                                         .replace(/'/g, '"'); 
                                parsed = JSON.parse(fixedStr);
                            } catch (regexErr) {
                                throw new Error("Could not parse config.");
                            }
                        }
                    }

                    if (!parsed || !parsed.apiKey || !parsed.projectId) {
                        throw new Error("Invalid config.");
                    }
                    
                    onSave(JSON.stringify(parsed));
                } catch (e) {
                    setError("Error: " + e.message);
                }
            };

            return (
                <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg p-8 space-y-6">
                        <div className="text-center">
                            <div className="bg-blue-100 p-4 rounded-full w-16 h-16 mx-auto flex items-center justify-center mb-4">
                                <Icons.Wrench className="w-8 h-8 text-blue-600"/>
                            </div>
                            <h1 className="text-2xl font-bold text-slate-900">Connect to Firebase</h1>
                            <p className="text-slate-500 mt-2">Paste your Firebase Project Configuration below to start.</p>
                        </div>

                        <div className="bg-amber-50 border border-amber-200 rounded-lg p-3 text-sm text-amber-800">
                            <strong className="block mb-1">Why is this here?</strong>
                            To keep your GitHub repository secure, we don't store your database keys in the code. They are saved securely in your browser instead.
                        </div>

                        <div className="space-y-2">
                            <label className="text-sm font-bold text-slate-700">Firebase Config Object</label>
                            <textarea 
                                className="w-full h-48 p-3 font-mono text-xs border rounded-lg bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none"
                                value={configStr}
                                onChange={(e) => setConfigStr(e.target.value)}
                            ></textarea>
                            {error && <p className="text-red-600 text-sm font-bold">{error}</p>}
                            <p className="text-xs text-slate-400">Found in Firebase Console > Project Settings > General > Your Apps > SDK Setup and Configuration (Config).</p>
                        </div>

                        <Button onClick={handleSave} className="w-full justify-center py-3 text-lg">Save & Connect</Button>
                    </div>
                </div>
            );
        };

        function App() {
            const [configLoaded, setConfigLoaded] = useState(isConfigured);

            if (!configLoaded) {
                return <SetupScreen onSave={(str) => {
                    localStorage.setItem('maintenance_invoicer_firebase_config', str);
                    window.location.reload(); 
                }} />;
            }

            const [user, setUser] = useState(null);
            const [view, setView] = useState('dashboard');
            const [invoices, setInvoices] = useState([]);
            const [clients, setClients] = useState([]);
            const [items, setItems] = useState([]); 
            const [settings, setSettings] = useState(null);
            const [loading, setLoading] = useState(true);
            const [currentInvoice, setCurrentInvoice] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [filter, setFilter] = useState('All');
            const [modal, setModal] = useState({ isOpen: false, title: '', message: '', onConfirm: () => {} });
            const [toast, setToast] = useState({ show: false, message: '', type: 'info' });
            
            const [clientForm, setClientForm] = useState({ name: '', email: '', phone: '', address: '' });
            const [itemForm, setItemForm] = useState({ description: '', rate: '', cost: '', type: 'material' });

            const [showCosts, setShowCosts] = useState(false);
            const [automationOpen, setAutomationOpen] = useState(false);
            const [showSignaturePad, setShowSignaturePad] = useState(false); // New: Signature Modal

            const showToast = (message, type = 'info') => {
                setToast({ show: true, message, type });
                setTimeout(() => setToast(prev => ({ ...prev, show: false })), 3000);
            };

            const sendEmail = async (params) => {
                if (!settings?.emailjsServiceId || !settings?.emailjsTemplateId || !settings?.emailjsPublicKey) {
                    throw new Error("EmailJS not configured.");
                }
                emailjs.init(settings.emailjsPublicKey);
                return emailjs.send(settings.emailjsServiceId, settings.emailjsTemplateId, params);
            };

            const availableServices = useMemo(() => {
                const settingsRates = settings?.serviceRates || {};
                const processedDefaults = PREDEFINED_SERVICES_DEFAULTS.map(service => ({
                    ...service,
                    rate: settingsRates[service.id] !== undefined ? Number(settingsRates[service.id]) : service.rate
                }));
                const savedItems = items.map(item => ({
                    id: item.id,
                    label: item.description,
                    description: item.description,
                    rate: Number(item.rate),
                    cost: Number(item.cost || 0),
                    type: item.type
                }));
                return [...savedItems, ...processedDefaults];
            }, [settings, items]);

            useEffect(() => {
                if (!auth) return;

                const initAuth = async () => {
                    try {
                        await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                    } catch (e) {
                        console.error("Persistence error:", e);
                    }

                    auth.onAuthStateChanged(async (u) => {
                        if (u) {
                            setUser(u);
                            setLoading(false);
                        } else {
                            try {
                                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                    await auth.signInWithCustomToken(__initial_auth_token);
                                } else {
                                    await auth.signInAnonymously();
                                }
                            } catch (error) {
                                console.error("Sign in error:", error);
                                setLoading(false);
                            }
                        }
                    });
                };
                
                initAuth();
            }, []);

            useEffect(() => {
                if (invoices.length > 0) {
                    const now = new Date();
                    const isMonday = now.getDay() === 1; 
                    const hour = now.getHours();
                    const todayStr = now.toDateString();
                    
                    if (isMonday && hour >= 8 && localStorage.getItem('monday_automation_date') !== todayStr) {
                        const overdueCount = invoices.filter(inv => (inv.status === 'Pending' || inv.status === 'Overdue') && new Date(inv.dueDate) < new Date()).length;
                        
                        if (overdueCount > 0) {
                            setAutomationOpen(true);
                            localStorage.setItem('monday_automation_date', todayStr);
                        }
                    }
                }
            }, [invoices]);

            useEffect(() => {
                const ref = getCollectionRef('invoices');
                if (!ref) {
                    setLoading(false);
                    return;
                }

                const unsubInvoices = ref.onSnapshot(snap => {
                    setInvoices(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0)));
                    setLoading(false);
                }, (err) => console.error(err));

                const unsubClients = getCollectionRef('clients').onSnapshot(snap => {
                    setClients(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => a.name.localeCompare(b.name)));
                });

                const unsubItems = getCollectionRef('items').onSnapshot(snap => {
                    setItems(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => a.description.localeCompare(b.description)));
                });

                const unsubSettings = getCollectionRef('settings').doc('preferences').onSnapshot(doc => {
                    if (doc.exists) setSettings(doc.data());
                });

                return () => { unsubInvoices(); unsubClients(); unsubSettings(); unsubItems(); };
            }, [user]);

            useEffect(() => {
                const handleKeyDown = (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                        e.preventDefault();
                        if (view === 'editor' && currentInvoice) {
                            saveInvoice();
                        }
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [view, currentInvoice]); 

            const cleanDataForFirestore = (obj) => {
                const newObj = {};
                Object.keys(obj).forEach(key => {
                    const val = obj[key];
                    if (val !== undefined) {
                        if (Array.isArray(val)) {
                            newObj[key] = val.map(item => cleanDataForFirestore(item));
                        } else if (val && typeof val === 'object' && !(val instanceof Date)) {
                             if (val.constructor && val.constructor.name === 'FieldValue') {
                                 newObj[key] = val;
                             } else {
                                newObj[key] = cleanDataForFirestore(val);
                             }
                        } else {
                            newObj[key] = val;
                        }
                    }
                });
                return newObj;
            };

            const processLogo = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (e) => {
                        const img = new Image();
                        img.src = e.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            ctx.drawImage(img, 0, 0);
                            resolve(canvas.toDataURL('image/jpeg', 0.8));
                        };
                    };
                });
            };

            const handleLogoUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    setLoading(true);
                    const base64 = await processLogo(file);
                    setSettings(prev => ({...prev, companyLogo: base64}));
                    showToast("Logo processed!", "success");
                } catch(err) {
                    showToast(err.message, "error");
                } finally {
                    setLoading(false);
                }
            };

            const handleRemoveLogo = () => {
                setSettings(prev => {
                    const next = {...prev};
                    delete next.companyLogo;
                    return next;
                });
                showToast("Logo removed.", "info");
            };

            const saveInvoice = async () => {
                if (!user || !currentInvoice) return;
                setLoading(true);
                
                const items = currentInvoice.items || [];
                const expenses = currentInvoice.expenses || []; // New
                const discountVal = Number(currentInvoice.discountValue) || 0;
                const taxRate = Number(currentInvoice.taxRate) || 0;
                const deposit = Number(currentInvoice.deposit) || 0;
                const { subtotal, total, balanceDue } = calculateTotals(items, discountVal, currentInvoice.discountType, taxRate, deposit, expenses);
                
                const docData = { 
                    ...currentInvoice,
                    items: items.map(i => ({
                        id: i.id || generateId(),
                        description: i.description || '',
                        quantity: Number(i.quantity)||0, 
                        rate: Number(i.rate)||0,
                        cost: Number(i.cost)||0, 
                        type: i.type || 'labor'
                    })),
                    expenses: expenses.map(e => ({
                        id: e.id || generateId(),
                        description: e.description || '',
                        amount: Number(e.amount)||0
                    })),
                    discountValue: discountVal,
                    taxRate: taxRate,
                    deposit: deposit,
                    subtotal, total, balanceDue, 
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp() 
                };
                
                delete docData.id; 

                try {
                    const ref = getCollectionRef('invoices');
                    if (currentInvoice.id) {
                        await timeoutPromise(10000, ref.doc(currentInvoice.id).update(cleanDataForFirestore(docData)));
                    } else {
                        await timeoutPromise(10000, ref.add({ ...cleanDataForFirestore(docData), createdAt: firebase.firestore.FieldValue.serverTimestamp() }));
                    }
                    showToast("Document saved", "success");
                    setView('list'); 
                    setCurrentInvoice(null);
                } catch(e) { 
                    console.error("SAVE ERROR:", e); 
                    showToast("Error saving: " + e.message, "error"); 
                } finally {
                    setLoading(false);
                }
            };

            const handleDuplicateClick = (inv = currentInvoice) => {
                setModal({ isOpen: true, title: 'Duplicate Document', message: 'Create a copy?', onConfirm: () => duplicateDocument(inv) });
            };

            const duplicateDocument = async (sourceInvoice) => {
                if (!user || !sourceInvoice) return;
                setLoading(true);
                try {
                    const newItems = (sourceInvoice.items || []).map(item => ({...item, id: generateId()}));
                    const newExpenses = (sourceInvoice.expenses || []).map(e => ({...e, id: generateId()}));
                    const baseData = {
                        ...sourceInvoice,
                        number: `${sourceInvoice.number}-COPY`,
                        status: 'Draft',
                        date: new Date().toISOString().split('T')[0],
                        items: newItems,
                        expenses: newExpenses
                    };
                    delete baseData.id;
                    delete baseData.createdAt;
                    delete baseData.updatedAt;

                    const ref = getCollectionRef('invoices');
                    const docRef = await timeoutPromise(10000, ref.add(cleanDataForFirestore({ ...baseData, createdAt: firebase.firestore.FieldValue.serverTimestamp() })));
                    setCurrentInvoice({ ...baseData, id: docRef.id });
                    setView('editor'); 
                    showToast("Duplicated!", "success");
                } catch(e) { 
                    console.error(e); 
                    showToast("Failed: " + e.message, "error"); 
                } finally { setLoading(false); }
            };

            const handleConvertClick = () => {
                let newNumber = currentInvoice.number || '';
                if (newNumber.startsWith('QT')) newNumber = newNumber.replace('QT', 'INV');
                else if (!newNumber.startsWith('INV')) newNumber = `INV-${newNumber}`;
                setModal({ isOpen: true, title: 'Convert to Invoice', message: `Convert to Invoice ${newNumber}?`, onConfirm: () => convertToInvoice(newNumber) });
            };

            const convertToInvoice = async (newNumber) => {
                if (!user || !currentInvoice) return;
                const quoteIdToDelete = currentInvoice.id;
                setLoading(true);
                try {
                    const baseData = {
                        ...currentInvoice,
                        number: newNumber,
                        status: 'Draft',
                        date: new Date().toISOString().split('T')[0],
                        dueDate: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], 
                        notes: settings?.invoiceNotes || 'Thank you for your business!',
                        items: (currentInvoice.items || []).map(item => ({...item, id: generateId()})),
                        expenses: (currentInvoice.expenses || []).map(e => ({...e, id: generateId()}))
                    };
                    delete baseData.id;
                    delete baseData.createdAt;

                    const ref = getCollectionRef('invoices');
                    const docRef = await timeoutPromise(10000, ref.add(cleanDataForFirestore({ ...baseData, createdAt: firebase.firestore.FieldValue.serverTimestamp() })));
                    if (quoteIdToDelete) { await ref.doc(quoteIdToDelete).delete(); }
                    setCurrentInvoice({ ...baseData, id: docRef.id });
                    showToast("Converted!", "success");
                } catch(e) { console.error(e); showToast("Failed: " + e.message, "error"); } finally { setLoading(false); }
            };

            const updateStatus = async (id, newStatus) => {
                if (!user) return;
                try {
                     await getCollectionRef('invoices').doc(id).update({
                        status: newStatus,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                     });
                     showToast(`Status updated to ${newStatus}`, "success");
                } catch(e) {
                    console.error(e);
                    showToast("Failed to update status", "error");
                }
            };

            const deleteDocHandler = async (id, collectionName = 'invoices') => {
                setModal({
                    isOpen: true, title: 'Delete Item', message: 'Are you sure?',
                    onConfirm: async () => {
                        setLoading(true);
                        try {
                            await timeoutPromise(10000, getCollectionRef(collectionName).doc(id).delete());
                            if(collectionName === 'invoices') {
                                setView('list');
                                setCurrentInvoice(null);
                            }
                            showToast("Deleted", "success");
                        } catch(e) { console.error(e); showToast("Error: " + e.message, "error"); }
                        finally { setLoading(false); }
                    }
                });
            }

            const saveClient = async () => {
                try {
                    const ref = getCollectionRef('clients');
                    if (clientForm.id) {
                        await ref.doc(clientForm.id).update(clientForm);
                        showToast("Client updated", "success");
                    } else {
                        await ref.add({ ...clientForm, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                        showToast("Client added", "success");
                    }
                    setClientForm({ name: '', email: '', phone: '', address: '' });
                } catch(e) { console.error(e); showToast("Error saving client", "error"); }
            };

            const editClient = (client) => {
                setClientForm(client);
                window.scrollTo({ top: 0, behavior: 'smooth' }); 
            };

            const saveItem = async () => {
                try {
                    const ref = getCollectionRef('items');
                    if (itemForm.id) {
                        await ref.doc(itemForm.id).update(itemForm);
                        showToast("Item updated", "success");
                    } else {
                        await ref.add({ ...itemForm, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                        showToast("Item added", "success");
                    }
                    setItemForm({ description: '', rate: '', cost: '', type: 'material' }); 
                } catch(e) { console.error(e); showToast("Error saving item", "error"); }
            };

            const editItem = (item) => {
                setItemForm(item);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const saveSettingsHandler = async (data) => {
                try {
                    await getCollectionRef('settings').doc('preferences').set(data);
                    showToast("Settings Saved", "success");
                } catch(e) { console.error(e); showToast("Error saving settings", "error"); }
            };

            const exportData = async () => {
                if(!user) return;
                setLoading(true);
                try {
                    const data = { invoices, clients, settings, items }; 
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    showToast("Backup downloaded", "success");
                } catch(e) { console.error(e); showToast("Backup failed", "error"); }
                setLoading(false);
            };

            const handleDisconnect = () => {
                setModal({
                    isOpen: true,
                    title: 'Disconnect Database?',
                    message: 'Remove keys from browser?',
                    onConfirm: () => {
                        localStorage.removeItem('maintenance_invoicer_firebase_config');
                        window.location.reload();
                    }
                });
            };

            const createNew = (type, client = null) => {
                const isQuote = type === 'quote';
                const defaultRate = isQuote ? 0 : 550;
                const newItem = {
                    number: `${isQuote?'QT-':'INV-'}${String(invoices.length + 1).padStart(4, '0')}`,
                    status: isQuote ? 'Quote' : 'Draft',
                    date: new Date().toISOString().split('T')[0],
                    dueDate: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    clientName: client ? client.name : '', 
                    clientEmail: client ? client.email : '', 
                    billingAddress: client ? client.address : '', 
                    workDescription: '',
                    items: [{ id: generateId(), description: isQuote ? 'Labor Estimate' : 'Call Out Fee', type: 'labor', quantity: 1, rate: defaultRate, cost: 0 }],
                    expenses: [],
                    notes: isQuote ? (settings?.quoteNotes || '') : (settings?.invoiceNotes || ''),
                    bankingDetails: settings?.bankingDetails || '',
                    subtotal: 0, discountValue: 0, discountType: 'amount', taxRate: 15, deposit: 0, total: 0
                };
                setCurrentInvoice(newItem);
                setView('editor');
            };

            // ITEM REORDERING LOGIC
            const moveItem = (index, direction) => {
                const newItems = [...currentInvoice.items];
                const targetIndex = index + direction;
                if (targetIndex < 0 || targetIndex >= newItems.length) return;
                const temp = newItems[index];
                newItems[index] = newItems[targetIndex];
                newItems[targetIndex] = temp;
                setCurrentInvoice({ ...currentInvoice, items: newItems });
            };

            const filteredInvoices = invoices.filter(inv => {
                const match = inv.clientName?.toLowerCase().includes(searchTerm.toLowerCase()) || inv.number?.toLowerCase().includes(searchTerm.toLowerCase());
                if (!match) return false;
                if (filter === 'Quote') return inv.status === 'Quote';
                if (filter === 'Paid') return inv.status === 'Paid';
                if (filter === 'Unpaid') return (inv.status === 'Pending' || inv.status === 'Overdue' || inv.status === 'Draft');
                return true;
            });

            const metrics = useMemo(() => {
                const revInvs = invoices.filter(i => i.status !== 'Quote');
                const overdueInvs = invoices.filter(inv => (inv.status === 'Pending' || inv.status === 'Overdue') && new Date(inv.dueDate) < new Date());
                return {
                    revenue: revInvs.reduce((a, b) => a + (b.total || 0), 0),
                    outstanding: revInvs.filter(i => i.status === 'Pending' || i.status === 'Overdue').reduce((a, b) => a + (b.balanceDue ?? b.total), 0),
                    potential: invoices.filter(i => i.status === 'Quote').reduce((a, b) => a + (b.total || 0), 0),
                    completed: revInvs.filter(i => i.status === 'Paid').length,
                    overdueCount: overdueInvs.length
                };
            }, [invoices]);

            // --- VIEW RENDERING ---
            if (view === 'preview') {
                const { subtotal, discountAmount, taxAmount, total, balanceDue, depositRequired60 } = calculateTotals(currentInvoice.items, currentInvoice.discountValue, currentInvoice.discountType, currentInvoice.taxRate, currentInvoice.deposit, currentInvoice.expenses);
                const isQuote = currentInvoice.status === 'Quote';
                
                const handleShareClick = async () => {
                    const element = document.getElementById('print-container');
                    setLoading(true);
                    
                    try {
                        const pdfBlob = await html2pdf().from(element).output('blob');
                        const pdfFile = new File([pdfBlob], `${currentInvoice.number}.pdf`, { type: 'application/pdf' });

                        if (navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
                            await navigator.share({
                                files: [pdfFile],
                                title: currentInvoice.number,
                                text: `Attached is your document.`
                            });
                        } else {
                            const link = document.createElement('a');
                            link.href = URL.createObjectURL(pdfBlob);
                            link.download = `${currentInvoice.number}.pdf`;
                            link.click();
                            window.location.href = `mailto:${currentInvoice.clientEmail}?subject=${currentInvoice.number}&body=Attached.`;
                            showToast("PDF Downloaded", "warning");
                        }
                    } catch (err) {
                        console.error(err);
                        if (err.name !== 'AbortError') showToast("Error sharing", "error");
                    } finally {
                        setLoading(false);
                    }
                };

                const handleDownloadPDF = () => {
                    const element = document.getElementById('print-container');
                    html2pdf().from(element).save();
                };

                return (
                    <div className="flex flex-col h-screen bg-slate-800">
                        <div className="bg-slate-900 text-white p-4 flex justify-between items-center no-print">
                            <Button variant="ghost" onClick={() => setView('editor')} className="text-slate-300"><Icons.ChevronLeft className="w-4 h-4 mr-2"/> Back</Button>
                            <div className="flex gap-2">
                                <Button variant="secondary" onClick={handleDownloadPDF}><Icons.Download className="w-4 h-4 mr-2"/> PDF</Button>
                                <Button variant="secondary" onClick={handleShareClick}><Icons.Send className="w-4 h-4 mr-2"/> Share</Button>
                                <Button variant="primary" onClick={() => window.print()}><Icons.Printer className="w-4 h-4 mr-2"/> Print</Button>
                            </div>
                        </div>
                        <div className="flex-1 overflow-auto p-8 bg-slate-800 print:p-0 print:bg-white flex justify-center">
                            <div id="print-container" className="bg-white w-full max-w-[210mm] min-h-[297mm] p-[20mm] shadow-2xl print:shadow-none print:w-full">
                                <div className="flex justify-between items-start mb-12">
                                    <div className="flex flex-col">
                                        {settings?.companyLogo ? <img src={settings.companyLogo} alt="Logo" className="h-20 w-auto object-contain mb-4 self-start" /> : null}
                                        <h1 className="text-4xl font-bold text-slate-900 leading-none">{isQuote ? 'QUOTE' : 'INVOICE'}</h1>
                                        <p className="text-slate-500 text-lg">#{currentInvoice.number}</p>
                                    </div>
                                    <div className="text-right">
                                        <h2 className="font-bold text-xl">{settings?.companyName}</h2>
                                        <p className="text-slate-500 text-sm whitespace-pre-line">{settings?.companyAddress}</p>
                                        <p className="text-slate-500 text-sm">{settings?.companyEmail}</p>
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-12 mb-8">
                                    <div><h3 className="text-xs font-bold text-slate-400 uppercase mb-2">Bill To</h3><p className="font-bold">{currentInvoice.clientName}</p><p className="text-slate-600 whitespace-pre-line">{currentInvoice.billingAddress}</p></div>
                                    <div><div className="flex justify-between mb-2"><span className="font-bold text-slate-600">Date:</span><span>{formatDate(currentInvoice.date)}</span></div><div className="flex justify-between"><span className="font-bold text-slate-600">{isQuote ? 'Valid Until:' : 'Due Date:'}</span><span>{formatDate(currentInvoice.dueDate)}</span></div></div>
                                </div>
                                <table className="w-full mb-8">
                                    <thead><tr className="border-b-2 border-slate-800 text-left"><th className="py-2">Description</th><th className="text-center">Qty</th><th className="text-right">Rate</th><th className="text-right">Amount</th></tr></thead>
                                    <tbody>
                                        {currentInvoice.workDescription && <tr className="border-b border-slate-100"><td colSpan="4" className="py-4 text-slate-700 whitespace-pre-wrap italic">{currentInvoice.workDescription}</td></tr>}
                                        {currentInvoice.items.map(item => (<tr key={item.id} className="border-b border-slate-100"><td className="py-4">{item.description}</td><td className="py-4 text-center">{item.quantity}</td><td className="py-4 text-right">{formatCurrency(item.rate)}</td><td className="py-4 text-right font-bold">{formatCurrency(item.quantity * item.rate)}</td></tr>))}
                                    </tbody>
                                </table>
                                <div className="flex justify-end">
                                    <div className="w-64 space-y-2">
                                        <div className="flex justify-between"><span>Subtotal</span><span>{formatCurrency(subtotal)}</span></div>
                                        {discountAmount > 0 && <div className="flex justify-between text-red-500"><span>Discount</span><span>-{formatCurrency(discountAmount)}</span></div>}
                                        <div className="flex justify-between"><span>VAT ({currentInvoice.taxRate}%)</span><span>{formatCurrency(taxAmount)}</span></div>
                                        <div className="flex justify-between font-bold text-lg border-t border-slate-800 pt-2"><span>Total</span><span>{formatCurrency(total)}</span></div>
                                        <div className="flex justify-between text-indigo-600 font-bold pt-2 border-t border-indigo-100"><span>Req. Deposit (60%)</span><span>{formatCurrency(depositRequired60)}</span></div>
                                        {!isQuote && currentInvoice.deposit > 0 && <div className="flex justify-between pt-2 border-t border-slate-200"><span>Paid</span><span>-{formatCurrency(currentInvoice.deposit)}</span></div>}
                                    </div>
                                </div>
                                <div className="mt-12 pt-8 border-t border-slate-100 grid grid-cols-2 gap-8">
                                    <div><h4 className="font-bold mb-2">Notes & Terms</h4><p className="text-sm text-slate-600 whitespace-pre-wrap">{currentInvoice.notes}</p></div>
                                    <div>{currentInvoice.bankingDetails && <div className="bg-slate-50 p-4 rounded-lg border border-slate-200"><h4 className="font-bold mb-2 text-slate-800 flex items-center gap-2"><Icons.Bank className="w-4 h-4"/> Banking Details</h4><p className="text-sm text-slate-600 whitespace-pre-wrap font-mono">{currentInvoice.bankingDetails}</p></div>}</div>
                                </div>
                                
                                {/* SIGNATURE SECTION IN PREVIEW */}
                                {currentInvoice.clientSignature && (
                                    <div className="mt-12 pt-8 border-t border-slate-100">
                                        <h4 className="font-bold mb-2 text-slate-400 text-xs uppercase">Client Signature</h4>
                                        <img src={currentInvoice.clientSignature} alt="Signature" className="h-16 w-auto object-contain" />
                                        <p className="text-xs text-slate-400 mt-1">Signed on {new Date().toLocaleDateString()}</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex h-screen overflow-hidden relative">
                    <aside className="w-64 bg-slate-900 text-slate-300 flex flex-col no-print">
                        <div className="p-6 font-bold text-white text-xl flex items-center gap-2"><Icons.Wrench/> MaintInvoicer</div>
                        <nav className="flex-1 px-4 space-y-2">
                            {['dashboard','list','calendar','reminders','clients','items','settings'].map(v => (<button key={v} onClick={() => setView(v)} className={`w-full flex items-center p-3 rounded-lg capitalize ${view === v ? 'bg-blue-600 text-white' : 'hover:bg-slate-800'}`}>{v === 'reminders' ? <span className="flex items-center gap-2"><Icons.MailWarning className="w-4 h-4"/> Reminders {metrics.overdueCount > 0 && v !== 'reminders' && <span className="bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full ml-auto">{metrics.overdueCount}</span>}</span> : (v === 'items' ? <span className="flex items-center gap-2"><Icons.Box className="w-4 h-4"/> Items</span> : v === 'calendar' ? <span className="flex items-center gap-2"><Icons.Calendar className="w-4 h-4"/> Calendar</span> : v)}</button>))}
                        </nav>
                        {user && <div className="p-4 border-t border-slate-800"><div className="text-xs text-slate-500 mb-1">Status:</div><div className="text-xs font-mono text-emerald-400 truncate flex items-center gap-2"><div className="w-2 h-2 bg-emerald-500 rounded-full"></div>Connected</div></div>}
                    </aside>
                    <main className="flex-1 overflow-auto p-8 relative z-0">
                        {view === 'dashboard' && (
                            <div className="space-y-6">
                                <div className="flex justify-between items-center"><h1 className="text-2xl font-bold">Dashboard</h1><div className="flex gap-2"><Button onClick={() => createNew('quote')} variant="secondary"><Icons.FileAxis3d className="w-4 h-4 mr-2"/> New Quote</Button><Button onClick={() => createNew('invoice')}><Icons.Plus className="w-4 h-4 mr-2"/> New Invoice</Button></div></div>
                                {metrics.overdueCount > 0 && <div className="bg-red-50 border border-red-200 rounded-xl p-4 flex items-center justify-between animate-fade-in shadow-sm"><div className="flex items-center gap-3"><div className="bg-red-100 p-2 rounded-full text-red-600"><Icons.MailWarning className="w-6 h-6" /></div><div><h3 className="font-bold text-red-800 text-lg">Action Required: {metrics.overdueCount} Overdue Invoices</h3><p className="text-sm text-red-600">You have {metrics.overdueCount} overdue invoices.</p></div></div><Button variant="danger" onClick={() => setAutomationOpen(true)}>View Reminders</Button></div>}
                                <div className="grid grid-cols-4 gap-4"><div className="bg-white p-6 rounded-xl border shadow-sm"><span className="text-sm text-slate-500">Revenue</span><div className="text-2xl font-bold">{formatCurrency(metrics.revenue)}</div></div><div className="bg-white p-6 rounded-xl border shadow-sm"><span className="text-sm text-slate-500">Outstanding</span><div className="text-2xl font-bold text-amber-600">{formatCurrency(metrics.outstanding)}</div></div><div className="bg-white p-6 rounded-xl border shadow-sm"><span className="text-sm text-slate-500">Potential</span><div className="text-2xl font-bold text-indigo-600">{formatCurrency(metrics.potential)}</div></div><div className="bg-white p-6 rounded-xl border shadow-sm"><span className="text-sm text-slate-500">Paid Invoices</span><div className="text-2xl font-bold text-emerald-600">{metrics.completed}</div></div></div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6"><div className="bg-white p-6 rounded-xl border shadow-sm h-80"><h3 className="font-bold text-slate-700 mb-4">Financial Performance</h3><div className="h-64"><RevenueChart invoices={invoices} /></div></div><div className="bg-white p-6 rounded-xl border shadow-sm h-80 overflow-y-auto custom-scroll"><h3 className="font-bold text-slate-700 mb-4">Recent Activity</h3><div className="space-y-3">{invoices.slice(0, 6).map(inv => (<div key={inv.id} className="flex justify-between items-center p-3 hover:bg-slate-50 rounded-lg cursor-pointer" onClick={() => { setCurrentInvoice(inv); setView('editor'); }}><div className="flex items-center gap-3"><div className={`p-2 rounded-lg ${inv.status === 'Quote' ? 'bg-indigo-50 text-indigo-600' : 'bg-blue-50 text-blue-600'}`}>{inv.status === 'Quote' ? <Icons.FileAxis3d className="w-4 h-4" /> : <Icons.FileText className="w-4 h-4" />}</div><div><div className="font-medium text-sm">{inv.number}</div><div className="text-xs text-slate-400">{inv.clientName}</div></div></div><div className="text-right"><div className="font-bold text-sm">{formatCurrency(inv.total)}</div><Badge status={inv.status} /></div></div>))}</div></div></div>
                            </div>
                        )}
                        {/* CALENDAR VIEW */}
                        {view === 'calendar' && (
                            <div className="space-y-6">
                                <h1 className="text-2xl font-bold">Calendar</h1>
                                <CalendarView invoices={invoices} onSelectInvoice={(inv) => { setCurrentInvoice(inv); setView('editor'); }} />
                            </div>
                        )}
                        {view === 'list' && (
                            <div className="space-y-6">
                                <div className="flex justify-between"><h1 className="text-2xl font-bold">Documents</h1><Button onClick={() => createNew('invoice')}><Icons.Plus className="w-4 h-4 mr-2"/> Create New</Button></div>
                                <div className="flex gap-4"><input placeholder="Search..." className="border p-2 rounded flex-1" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} /><div className="flex gap-1 bg-slate-100 p-1 rounded">{['All','Quote','Unpaid','Paid'].map(f => (<button key={f} onClick={() => setFilter(f)} className={`px-3 py-1 rounded text-sm ${filter === f ? 'bg-white shadow' : 'text-slate-500'}`}>{f}</button>))}</div></div>
                                <div className="bg-white rounded-xl border shadow-sm overflow-hidden"><table className="w-full text-left"><thead className="bg-slate-50 border-b"><tr><th className="p-4">Number</th><th className="p-4">Client</th><th className="p-4 text-right">Amount</th><th className="p-4 text-center">Status</th><th className="p-4"></th></tr></thead><tbody>{filteredInvoices.map(inv => (<tr key={inv.id} className="hover:bg-slate-50 border-b"><td className="p-4 font-medium">{inv.number}</td><td className="p-4">{inv.clientName}<div className="text-xs text-slate-500">{formatDate(inv.date)}</div></td><td className="p-4 text-right font-bold">{formatCurrency(inv.total)}</td><td className="p-4 text-center"><div className="flex justify-center group relative"><div className="cursor-pointer" onClick={() => { if(inv.status === 'Pending' || inv.status === 'Overdue' || inv.status === 'Draft') updateStatus(inv.id, 'Paid'); }}><Badge status={inv.status}/></div></div></td><td className="p-4 text-right flex justify-end gap-2"><Button variant="ghost" onClick={() => handleDuplicateClick(inv)}><Icons.Copy className="w-4 h-4 text-slate-400"/></Button><Button variant="ghost" onClick={() => { setCurrentInvoice(inv); setView('editor'); }}>Edit</Button></td></tr>))}</tbody></table></div>
                            </div>
                        )}
                        {view === 'clients' && (
                            <div className="space-y-6">
                                <h1 className="text-2xl font-bold">Clients</h1>
                                <div className="bg-slate-100 p-4 rounded-lg space-y-2"><h3 className="font-bold">{clientForm.id ? 'Edit Client' : 'Add Client'}</h3><form onSubmit={(e) => { e.preventDefault(); saveClient(); }}><div className="grid grid-cols-2 gap-2"><input name="name" placeholder="Name" className="p-2 border rounded" required value={clientForm.name} onChange={e => setClientForm({...clientForm, name: e.target.value})} /><input name="email" placeholder="Email" className="p-2 border rounded" value={clientForm.email} onChange={e => setClientForm({...clientForm, email: e.target.value})} /><input name="phone" placeholder="Phone" className="p-2 border rounded" value={clientForm.phone} onChange={e => setClientForm({...clientForm, phone: e.target.value})} /><input name="address" placeholder="Address" className="p-2 border rounded" value={clientForm.address} onChange={e => setClientForm({...clientForm, address: e.target.value})} /></div><div className="flex gap-2 mt-2"><Button type="submit">{clientForm.id ? 'Update Client' : 'Save Client'}</Button>{clientForm.id && <Button type="button" variant="secondary" onClick={() => setClientForm({ name: '', email: '', phone: '', address: '' })}>Cancel</Button>}</div></form></div>
                                <div className="bg-white rounded-xl border">
                                    {clients.map(c => (
                                        <div key={c.id} className="p-4 border-b flex justify-between items-center hover:bg-slate-50 transition-colors">
                                            <div><div className="font-bold text-lg">{c.name}</div><div className="text-sm text-slate-500">{c.email}</div><div className="text-xs text-slate-400">{c.address}</div></div>
                                            <div className="flex items-center gap-2">
                                                {/* ONE-TAP ACTIONS */}
                                                <a href={`tel:${c.phone}`} className="p-2 bg-green-50 text-green-600 rounded-lg hover:bg-green-100 border border-green-200" title="Call"><Icons.Phone className="w-4 h-4"/></a>
                                                <a href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(c.address)}`} target="_blank" className="p-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 border border-blue-200" title="Navigate"><Icons.MapPin className="w-4 h-4"/></a>
                                                <div className="h-6 w-px bg-slate-200 mx-1"></div>
                                                <Button variant="secondary" className="text-xs" onClick={() => createNew('quote', c)}>Quote</Button><Button variant="secondary" className="text-xs" onClick={() => createNew('invoice', c)}>Inv</Button>
                                                <Button variant="ghost" onClick={() => editClient(c)}><Icons.Edit className="w-4 h-4 text-slate-600"/></Button><Button variant="danger" onClick={() => deleteDocHandler(c.id, 'clients')}><Icons.Trash2 className="w-4 h-4"/></Button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        {/* Items View */}
                        {view === 'items' && (
                            <div className="space-y-6"><h1 className="text-2xl font-bold flex items-center gap-2"><Icons.Box className="w-6 h-6"/> Items & Rates</h1><div className="bg-slate-100 p-4 rounded-lg space-y-2 border border-slate-200"><h3 className="font-bold text-slate-700">{itemForm.id ? 'Edit Item' : 'Add New Item'}</h3><form onSubmit={(e) => { e.preventDefault(); saveItem(); }}><div className="grid grid-cols-1 md:grid-cols-4 gap-2"><div className="md:col-span-2"><input name="description" placeholder="Description" className="w-full p-2 border rounded" required value={itemForm.description} onChange={e => setItemForm({...itemForm, description: e.target.value})} /></div><div className="relative"><span className="absolute left-3 top-2 text-slate-400 text-sm">R</span><input type="number" name="rate" placeholder="Rate" className="w-full pl-6 p-2 border rounded" required value={itemForm.rate} onChange={e => setItemForm({...itemForm, rate: e.target.value})} /></div><div className="relative"><span className="absolute left-3 top-2 text-slate-400 text-sm">R</span><input type="number" name="cost" placeholder="Cost" className="w-full pl-6 p-2 border rounded" value={itemForm.cost} onChange={e => setItemForm({...itemForm, cost: e.target.value})} /></div></div><div className="flex gap-2 mt-2"><select className="p-2 border rounded bg-white" value={itemForm.type} onChange={e => setItemForm({...itemForm, type: e.target.value})}><option value="material">Material / Part</option><option value="labor">Labor</option><option value="travel">Travel</option></select><Button type="submit">{itemForm.id ? 'Update Item' : 'Save Item'}</Button>{itemForm.id && <Button type="button" variant="secondary" onClick={() => setItemForm({ description: '', rate: '', cost: '', type: 'material' })}>Cancel</Button>}</div></form></div><div className="bg-white rounded-xl border shadow-sm overflow-hidden"><table className="w-full text-left text-sm"><thead className="bg-slate-50 border-b"><tr><th className="p-3">Description</th><th className="p-3">Type</th><th className="p-3 text-right">Rate</th><th className="p-3 text-right text-slate-400">Cost</th><th className="p-3 text-right">Actions</th></tr></thead><tbody>{items.map(item => (<tr key={item.id} className="border-b hover:bg-slate-50"><td className="p-3 font-medium">{item.description}</td><td className="p-3"><span className="capitalize bg-slate-100 px-2 py-1 rounded text-xs text-slate-500">{item.type}</span></td><td className="p-3 text-right font-mono">{formatCurrency(item.rate)}</td><td className="p-3 text-right font-mono text-slate-400">{item.cost ? formatCurrency(item.cost) : '-'}</td><td className="p-3 text-right flex justify-end gap-2"><Button variant="ghost" className="p-1 h-8" onClick={() => editItem(item)}><Icons.Edit className="w-4 h-4 text-slate-600"/></Button><Button variant="danger" className="p-1 h-8" onClick={() => deleteDocHandler(item.id, 'items')}><Icons.Trash2 className="w-4 h-4"/></Button></td></tr>))}</tbody></table></div></div>
                        )}
                        {view === 'settings' && (
                            <div className="max-w-2xl"><h1 className="text-2xl font-bold mb-6">Settings</h1><div className="bg-white p-6 rounded-xl border shadow-sm space-y-6"><div><h3 className="font-bold text-lg mb-2">Company Details</h3><div className="mb-6 bg-slate-50 p-4 rounded-lg border border-slate-200"><label className="text-sm font-bold text-slate-700 block mb-2">Company Logo</label><div className="flex items-start gap-4">{settings?.companyLogo ? (<div className="relative group"><img src={settings.companyLogo} alt="Logo" className="h-20 w-auto object-contain border bg-white rounded" /><button onClick={handleRemoveLogo} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity"><Icons.Trash2 className="w-3 h-3" /></button></div>) : (<div className="h-20 w-20 bg-white border border-dashed border-slate-300 rounded flex items-center justify-center text-slate-300"><Icons.Image className="w-8 h-8" /></div>)}<div className="flex-1"><input type="file" accept="image/*" onChange={handleLogoUpload} className="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" /><p className="text-xs text-slate-400 mt-2">Recommended: PNG or JPG with transparent background. Max 2MB.</p></div></div></div><div className="space-y-4"><Input label="Company Name" value={settings?.companyName || ''} onChange={e => setSettings({...settings, companyName: e.target.value})} /><div className="grid grid-cols-2 gap-4"><Input label="Email" value={settings?.companyEmail || ''} onChange={e => setSettings({...settings, companyEmail: e.target.value})} /><Input label="Phone" value={settings?.companyPhone || ''} onChange={e => setSettings({...settings, companyPhone: e.target.value})} /></div><Input label="Address" value={settings?.companyAddress || ''} onChange={e => setSettings({...settings, companyAddress: e.target.value})} /></div></div><div className="border-t pt-4"><h3 className="font-bold text-lg mb-2">Service Rates</h3><div className="grid grid-cols-1 md:grid-cols-2 gap-4">{PREDEFINED_SERVICES_DEFAULTS.filter(s => s.id !== 'custom').map(service => (<div key={service.id} className="flex flex-col gap-1"><label className="text-xs font-semibold text-slate-600">{service.label}</label><div className="relative"><span className="absolute left-3 top-2 text-slate-400">R</span><input type="number" className="w-full pl-8 p-2 border rounded" placeholder={service.rate} value={settings?.serviceRates?.[service.id] ?? service.rate} onChange={e => setSettings({ ...settings, serviceRates: { ...(settings?.serviceRates || {}), [service.id]: e.target.value } })} /></div></div>))}</div></div><div className="border-t pt-4 space-y-4"><h3 className="font-bold text-lg">Default Notes & Terms</h3><div><label className="text-sm font-bold text-slate-700">Default Quote Notes</label><textarea className="w-full border p-2 rounded h-20 text-sm" placeholder="This quote is valid for 30 days..." value={settings?.quoteNotes || ''} onChange={e => setSettings({...settings, quoteNotes: e.target.value})} /></div><div><label className="text-sm font-bold text-slate-700">Default Invoice Notes</label><textarea className="w-full border p-2 rounded h-20 text-sm" placeholder="Thank you for your business..." value={settings?.invoiceNotes || ''} onChange={e => setSettings({...settings, invoiceNotes: e.target.value})} /></div><div><label className="text-sm font-bold text-slate-700">Banking Details</label><textarea className="w-full border p-2 rounded h-24 text-sm font-mono" placeholder="Bank Name: &#10;Account No: &#10;Branch Code:" value={settings?.bankingDetails || ''} onChange={e => setSettings({...settings, bankingDetails: e.target.value})} /><p className="text-xs text-slate-400 mt-1">These details will appear on PDF Quotes and Invoices.</p></div></div><div className="border-t pt-4 space-y-4"><h3 className="font-bold text-lg">Email Automation (EmailJS)</h3><div className="grid grid-cols-3 gap-4"><Input label="Service ID" value={settings?.emailjsServiceId || ''} onChange={e => setSettings({...settings, emailjsServiceId: e.target.value})} /><Input label="Template ID" value={settings?.emailjsTemplateId || ''} onChange={e => setSettings({...settings, emailjsTemplateId: e.target.value})} /><Input label="Public Key" value={settings?.emailjsPublicKey || ''} onChange={e => setSettings({...settings, emailjsPublicKey: e.target.value})} /></div></div><div className="border-t pt-4"><div className="flex gap-2"><Button onClick={exportData} variant="secondary"><Icons.Download className="w-4 h-4 mr-2"/> Export Data Backup</Button><Button onClick={handleDisconnect} variant="danger">Disconnect Database</Button></div></div><Button onClick={() => saveSettingsHandler(settings)}>Save Settings</Button></div></div>
                        )}
                        {/* EDITOR WITH PROFIT HEALTH & SIGNATURE */}
                        {view === 'editor' && currentInvoice && (
                            <div className="max-w-4xl mx-auto pb-20">
                                <div className="flex justify-between items-center mb-6"><Button variant="ghost" onClick={() => setView('list')}><Icons.ChevronLeft className="w-4 h-4 mr-2"/> Back</Button><div className="flex gap-2">{currentInvoice.status === 'Quote' && currentInvoice.id && <Button variant="success" onClick={handleConvertClick}><Icons.ArrowRight className="w-4 h-4 mr-2"/> Convert to Inv</Button>}{currentInvoice.id && <Button variant="secondary" onClick={() => handleDuplicateClick()}><Icons.Copy className="w-4 h-4 mr-2"/> Duplicate</Button>}<Button variant="secondary" onClick={() => setView('preview')}><Icons.Printer className="w-4 h-4 mr-2"/> Preview</Button><Button onClick={saveInvoice} title="Ctrl + S to Save"><Icons.Save className="w-4 h-4 mr-2"/> Save</Button></div></div>
                                <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                                    <div className="p-6 bg-slate-50 border-b grid grid-cols-3 gap-4"><Input label="Number" value={currentInvoice.number} onChange={e => setCurrentInvoice({...currentInvoice, number: e.target.value})} /><Input type="date" label="Date" value={currentInvoice.date} onChange={e => { const newDate = e.target.value; const dueDate = new Date(new Date(newDate).getTime() + 14 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]; setCurrentInvoice({...currentInvoice, date: newDate, dueDate: dueDate}); }} /><div><label className="text-sm font-bold">Status</label><select className="w-full p-2 border rounded" value={currentInvoice.status} onChange={e => setCurrentInvoice({...currentInvoice, status: e.target.value})}>{['Draft','Quote','Pending','Paid','Overdue'].map(s => <option key={s} value={s}>{s}</option>)}</select></div></div>
                                    <div className="p-6 space-y-4">
                                        <div className="grid grid-cols-2 gap-6">
                                            <div className="space-y-2">
                                                <label className="text-sm font-bold">Client</label>
                                                <ClientSelect clients={clients} value={currentInvoice.clientName} onSelect={(c) => setCurrentInvoice({...currentInvoice, clientName: c.name, clientEmail: c.email, billingAddress: c.address})} />
                                                <Input placeholder="Email" value={currentInvoice.clientEmail} onChange={e => setCurrentInvoice({...currentInvoice, clientEmail: e.target.value})} />
                                                <div className="relative">
                                                    <textarea placeholder="Billing Address" className="w-full p-2 border rounded h-20" value={currentInvoice.billingAddress} onChange={e => setCurrentInvoice({...currentInvoice, billingAddress: e.target.value})} />
                                                    {/* MAP LINK */}
                                                    {currentInvoice.billingAddress && <a href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(currentInvoice.billingAddress)}`} target="_blank" className="absolute top-2 right-2 p-1.5 bg-blue-100 text-blue-600 rounded-md hover:bg-blue-200" title="Open Map"><Icons.MapPin className="w-4 h-4"/></a>}
                                                </div>
                                            </div>
                                            <div className="space-y-2"><label className="text-sm font-bold">Job Details</label><textarea placeholder="Work Description (Scope of Work)" className="w-full p-2 border rounded h-20" value={currentInvoice.workDescription} onChange={e => setCurrentInvoice({...currentInvoice, workDescription: e.target.value})} /><Input type="date" label="Due Date" value={currentInvoice.dueDate} onChange={e => setCurrentInvoice({...currentInvoice, dueDate: e.target.value})} /></div>
                                        </div>
                                        <div className="border-t pt-4">
                                            <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-slate-800">Items & Charges</h3><div className="flex items-center gap-2"><span className="text-sm text-slate-500">Show Costs (Profit)</span><button onClick={() => setShowCosts(!showCosts)} className={`w-10 h-6 rounded-full p-1 transition-colors ${showCosts ? 'bg-blue-600' : 'bg-slate-300'}`}><div className={`w-4 h-4 bg-white rounded-full shadow-md transform transition-transform ${showCosts ? 'translate-x-4' : 'translate-x-0'}`}></div></button></div></div>
                                            <div className="space-y-3">
                                                {currentInvoice.items.map((item, idx) => (
                                                    <div key={item.id} className="flex flex-col md:flex-row gap-2 items-start bg-slate-50 p-3 rounded-lg border border-slate-200">
                                                        <div className="flex flex-col gap-1 pt-1">
                                                            {/* REORDER BUTTONS */}
                                                            <button onClick={() => moveItem(idx, -1)} className="p-1 hover:bg-slate-200 rounded text-slate-400 hover:text-slate-600"><Icons.ArrowUp className="w-4 h-4"/></button>
                                                            <button onClick={() => moveItem(idx, 1)} className="p-1 hover:bg-slate-200 rounded text-slate-400 hover:text-slate-600"><Icons.ArrowDown className="w-4 h-4"/></button>
                                                        </div>
                                                        <div className="flex-1 w-full">
                                                            <label className="text-[10px] uppercase font-bold text-slate-400 mb-1 block">Item</label>
                                                            <select className="w-full p-2 border rounded bg-white text-slate-700 mb-2 text-sm" onChange={(e) => { const service = availableServices.find(s => s.id === e.target.value); if (service && service.id !== 'custom') { const newItems = [...currentInvoice.items]; newItems[idx].description = service.description; newItems[idx].rate = service.rate; newItems[idx].cost = service.cost || 0; setCurrentInvoice({...currentInvoice, items: newItems}); } }} defaultValue=""><option value="" disabled>Select...</option>{availableServices.map(s => <option key={s.id} value={s.id}>{s.label}</option>)}</select>
                                                            <input className="w-full p-2 border rounded bg-white" placeholder="Description" value={item.description} onChange={e => { const newItems = [...currentInvoice.items]; newItems[idx].description = e.target.value; setCurrentInvoice({...currentInvoice, items: newItems}); }} />
                                                        </div>
                                                        <div className="flex gap-2 w-full md:w-auto">
                                                            <div className="w-20"><label className="text-[10px] uppercase font-bold text-slate-400 mb-1 block">Qty</label><input type="number" className="w-full p-2 border rounded bg-white text-center" value={item.quantity} onChange={e => { const newItems = [...currentInvoice.items]; newItems[idx].quantity = Number(e.target.value); setCurrentInvoice({...currentInvoice, items: newItems}); }} /></div>
                                                            <div className="w-28"><label className="text-[10px] uppercase font-bold text-slate-400 mb-1 block">Rate</label><input type="number" className="w-full p-2 border rounded bg-white text-right" value={item.rate} onChange={e => { const newItems = [...currentInvoice.items]; newItems[idx].rate = Number(e.target.value); setCurrentInvoice({...currentInvoice, items: newItems}); }} /></div>
                                                            {showCosts && (<div className="w-24"><label className="text-[10px] uppercase font-bold text-slate-400 mb-1 block text-orange-600">Cost</label><input type="number" className="w-full p-2 border border-orange-200 rounded bg-orange-50 text-right text-orange-800" value={item.cost || 0} onChange={e => { const newItems = [...currentInvoice.items]; newItems[idx].cost = Number(e.target.value); setCurrentInvoice({...currentInvoice, items: newItems}); }} /></div>)}
                                                            <div className="pt-6"><Button variant="danger" className="h-[42px]" onClick={() => { const newItems = currentInvoice.items.filter(i => i.id !== item.id); setCurrentInvoice({...currentInvoice, items: newItems}); }}><Icons.Trash2 className="w-4 h-4"/></Button></div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                            <Button variant="secondary" className="mt-4" onClick={() => setCurrentInvoice({...currentInvoice, items: [...currentInvoice.items, { id: generateId(), description: '', quantity: 1, rate: 0, cost: 0 }]})}><Icons.Plus className="w-4 h-4 mr-2"/> Add Line Item</Button>
                                        </div>

                                        {/* EXPENSES SECTION */}
                                        <div className="border-t pt-4 bg-orange-50/50 p-4 rounded-lg border border-orange-100">
                                            <div className="flex justify-between items-center mb-2">
                                                <h3 className="font-bold text-orange-800 flex items-center gap-2"><Icons.CreditCard className="w-4 h-4"/> Job Expenses (Internal)</h3>
                                                <span className="text-xs text-orange-600">Not shown on client invoice</span>
                                            </div>
                                            <div className="space-y-2">
                                                {(currentInvoice.expenses || []).map((exp, idx) => (
                                                    <div key={exp.id} className="flex gap-2">
                                                        <input className="flex-1 p-2 border border-orange-200 rounded text-sm" placeholder="Expense (e.g. Fuel, Parts bought)" value={exp.description} onChange={e => { const newExp = [...(currentInvoice.expenses || [])]; newExp[idx].description = e.target.value; setCurrentInvoice({...currentInvoice, expenses: newExp}); }} />
                                                        <input type="number" className="w-24 p-2 border border-orange-200 rounded text-right text-sm" placeholder="0.00" value={exp.amount} onChange={e => { const newExp = [...(currentInvoice.expenses || [])]; newExp[idx].amount = Number(e.target.value); setCurrentInvoice({...currentInvoice, expenses: newExp}); }} />
                                                        <Button variant="danger" className="px-2" onClick={() => { const newExp = (currentInvoice.expenses || []).filter(e => e.id !== exp.id); setCurrentInvoice({...currentInvoice, expenses: newExp}); }}><Icons.X className="w-4 h-4"/></Button>
                                                    </div>
                                                ))}
                                                <Button variant="secondary" className="text-xs text-orange-700 border-orange-200 bg-white hover:bg-orange-50" onClick={() => setCurrentInvoice({...currentInvoice, expenses: [...(currentInvoice.expenses || []), { id: generateId(), description: '', amount: 0 }]})}>+ Add Expense</Button>
                                            </div>
                                        </div>
                                        
                                        <div className="border-t pt-4 grid grid-cols-2 gap-8">
                                            <div className="space-y-4">
                                                <div>
                                                    <label className="text-sm font-bold text-slate-700">Notes & Terms</label>
                                                    <textarea className="w-full border p-2 rounded h-24 text-sm mb-2" value={currentInvoice.notes} onChange={e => setCurrentInvoice({...currentInvoice, notes: e.target.value})} />
                                                    {/* QUICK SNIPPETS */}
                                                    <div className="flex gap-2 flex-wrap">
                                                        {['Standard Warranty', 'Payment Terms', 'Thank You'].map(text => (
                                                            <button key={text} onClick={() => setCurrentInvoice({...currentInvoice, notes: currentInvoice.notes + (currentInvoice.notes ? '\n\n' : '') + (text === 'Standard Warranty' ? 'All workmanship guaranteed for 6 months.' : text === 'Payment Terms' ? '50% Deposit required to commence work. Balance due on completion.' : 'Thank you for your business!')})} className="text-[10px] bg-slate-100 hover:bg-slate-200 text-slate-600 px-2 py-1 rounded border border-slate-200 transition-colors">
                                                                + {text}
                                                            </button>
                                                        ))}
                                                    </div>
                                                </div>
                                                <div><label className="text-sm font-bold text-slate-700 flex items-center gap-2"><Icons.Bank className="w-3 h-3"/> Banking Details</label><textarea className="w-full border p-2 rounded h-24 text-sm font-mono" value={currentInvoice.bankingDetails || ''} onChange={e => setCurrentInvoice({...currentInvoice, bankingDetails: e.target.value})} /></div>
                                                {/* SIGNATURE BUTTON */}
                                                <div>
                                                    <label className="text-sm font-bold text-slate-700 mb-2 block">Client Approval</label>
                                                    <div className="flex items-center gap-4">
                                                        {currentInvoice.clientSignature ? (
                                                            <div className="relative group">
                                                                <img src={currentInvoice.clientSignature} alt="Signed" className="h-12 border bg-white" />
                                                                <button onClick={() => setCurrentInvoice({...currentInvoice, clientSignature: null})} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity"><Icons.X className="w-3 h-3"/></button>
                                                            </div>
                                                        ) : (
                                                            <Button variant="secondary" onClick={() => setShowSignaturePad(true)}><Icons.PenTool className="w-4 h-4 mr-2"/> Capture Signature</Button>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="space-y-2 text-right">
                                                <div className="flex justify-between items-center"><span className="text-sm">Discount</span><input type="number" className="border p-1 rounded w-20 text-right" value={currentInvoice.discountValue} onChange={e => setCurrentInvoice({...currentInvoice, discountValue: Number(e.target.value)})} /></div>
                                                <div className="flex justify-between items-center"><span className="text-sm">Deposit Paid</span><input type="number" className="border p-1 rounded w-20 text-right" value={currentInvoice.deposit} onChange={e => setCurrentInvoice({...currentInvoice, deposit: Number(e.target.value)})} /></div>
                                                <div className="text-xl font-bold">Total: {formatCurrency(calculateTotals(currentInvoice.items, currentInvoice.discountValue, currentInvoice.discountType, currentInvoice.taxRate, currentInvoice.deposit, currentInvoice.expenses).total)}</div>
                                                
                                                {/* PROFIT HEALTH CHECK */}
                                                {(() => {
                                                    const { profit, margin } = calculateTotals(currentInvoice.items, currentInvoice.discountValue, currentInvoice.discountType, currentInvoice.taxRate, currentInvoice.deposit, currentInvoice.expenses);
                                                    let marginColor = 'text-emerald-600';
                                                    if (margin < 15) marginColor = 'text-red-600';
                                                    else if (margin < 35) marginColor = 'text-amber-600';
                                                    return (
                                                        <div className={`text-sm pt-2 border-t mt-2 flex justify-end items-center gap-2 ${marginColor}`}>
                                                            <span className="font-bold">Net Profit: {formatCurrency(profit)}</span>
                                                            <span className={`px-2 py-0.5 rounded text-xs font-bold ${margin < 15 ? 'bg-red-100' : (margin < 35 ? 'bg-amber-100' : 'bg-emerald-100')}`}>{margin.toFixed(1)}% Margin</span>
                                                        </div>
                                                    );
                                                })()}
                                            </div>
                                        </div>
                                    </div>
                                    {currentInvoice.id && (<div className="bg-slate-50 p-4 border-t flex justify-center"><Button variant="danger" onClick={() => deleteDocHandler(currentInvoice.id)}><Icons.Trash2 className="w-4 h-4 mr-2"/> Delete Document</Button></div>)}
                                </div>
                            </div>
                        )}
                    </main>

                    {/* OVERLAYS AT ROOT LEVEL FOR Z-INDEX CORRECTNESS */}
                    <BatchReminderModal isOpen={automationOpen} onClose={() => setAutomationOpen(false)} overdueInvoices={invoices.filter(inv => (inv.status === 'Pending' || inv.status === 'Overdue') && new Date(inv.dueDate) < new Date())} settings={settings} showToast={showToast} sendEmail={sendEmail} />
                    <SignatureModal isOpen={showSignaturePad} onClose={() => setShowSignaturePad(false)} onSave={(sig) => { setCurrentInvoice({...currentInvoice, clientSignature: sig}); setShowSignaturePad(false); }} />
                    
                    {modal.isOpen && (<div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[100] animate-fade-in"><div className="bg-white p-6 rounded-xl shadow-xl max-w-sm w-full mx-4 animate-slide-up"><h3 className="font-bold text-lg mb-2 text-slate-800">{modal.title}</h3><p className="text-slate-600 mb-6">{modal.message}</p><div className="flex justify-end gap-2"><Button variant="secondary" onClick={() => setModal({ ...modal, isOpen: false })}>Cancel</Button><Button onClick={() => { setModal({ ...modal, isOpen: false }); modal.onConfirm(); }}>Confirm</Button></div></div></div>)}
                    {toast.show && (<div className={`fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white font-medium animate-slide-up z-[110] ${toast.type === 'error' ? 'bg-red-600' : 'bg-emerald-600'}`}>{toast.message}</div>)}
                    {loading && (<div className="loading-overlay"><div className="bg-white p-6 rounded-xl shadow-2xl flex flex-col items-center"><div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-2"></div><div>Processing...</div></div></div>)}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
