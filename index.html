<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance Invoicer</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- 2. React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 3. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Firebase (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <!-- Storage removed from active logic to prevent errors, but script kept for compatibility -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <!-- 5. Chart.js (For Analytics) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- 6. html2pdf (For PDF Generation) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* Hide scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            .print-container { box-shadow: none; margin: 0; width: 100%; max-width: none; }
        }
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex; justify-content: center; align-items: center;
            z-index: 50;
        }
        /* Custom Scrollbar for dropdowns */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans h-screen overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        // --- ICONS ---
        const Icons = {
            Plus: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Trash2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Printer: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>,
            Save: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            FileText: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>,
            ChevronLeft: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>,
            LayoutDashboard: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>,
            Wrench: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>,
            Hammer: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 12-8.5 8.5c-.83.83-2.17.83-3 0 0 0 0 0 0 0a2.12 2.12 0 0 1 0-3L12 9"/><path d="M17.64 15 22 10.64"/><path d="m20.91 11.7-1.25-1.25c-.6-.6-.93-1.4-.93-2.25V7.86c0-.55-.45-1-1-1H14c-.55 0-1 .45-1 1v3.8c0 .85-.34 1.66-.93 2.25L10.82 15"/></svg>,
            User: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            MapPin: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>,
            CheckCircle: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            Clock: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            AlertCircle: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
            Search: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            CreditCard: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></svg>,
            AlignLeft: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="21" x2="3" y1="6" y2="6"/><line x1="15" x2="3" y1="12" y2="12"/><line x1="17" x2="3" y1="18" y2="18"/></svg>,
            FileAxis3d: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="m8 13 4 4"/><path d="m8 17 4-4"/></svg>,
            ArrowRight: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>,
            Users: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            Settings: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Mail: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>,
            Building: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="16" height="20" x="4" y="2" rx="2" ry="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M12 6h.01"/><path d="M12 10h.01"/><path d="M12 14h.01"/><path d="M16 10h.01"/><path d="M16 14h.01"/><path d="M8 10h.01"/><path d="M8 14h.01"/></svg>,
            Phone: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>,
            Bell: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>,
            Copy: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>,
            Filter: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>,
            ChevronDown: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg>,
            Download: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            DollarSign: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>,
            MoreVertical: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>,
            Bank: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 21h18"/><path d="M5 21v-7"/><path d="M19 21v-7"/><path d="M10 9L3 21"/><path d="M14 9l7 12"/><rect x="2" y="3" width="20" height="5"/><path d="M12 12v9"/></svg>,
            Upload: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            MailWarning: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 10.5V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v12c0 1.1.9 2 2 2h12.5"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/><path d="M20 14v4"/><path d="M20 22v.01"/></svg>,
            Image: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>,
            Link: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>,
            Send: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" x2="11" y1="2" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
            Edit: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
            X: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        };

        const { useState, useEffect, useMemo, useRef } = React;

        // --- FIREBASE CONFIGURATION ---
        let firebaseConfig;
        if (typeof __firebase_config !== 'undefined') {
            try {
                firebaseConfig = JSON.parse(__firebase_config);
            } catch (e) { console.error(e); }
        } 
        
        // ⚠️ IMPORTANT: When hosting on GitHub Pages, we use the user provided config
        if (!firebaseConfig) {
            firebaseConfig = {
                apiKey: "AIzaSyC_2VD_a8M-K6NiXjuS7JE4p96fboilFRs",
                authDomain: "maintenance-28808.firebaseapp.com",
                projectId: "maintenance-28808",
                storageBucket: "maintenance-28808.firebasestorage.app",
                messagingSenderId: "864099123620",
                appId: "1:864099123620:web:eed346d0a3319659124131",
                measurementId: "G-C9B2J75KV0"
            };
        }

        try {
            firebase.initializeApp(firebaseConfig);
        } catch(e) {
            console.error("Firebase Init Error:", e);
        }

        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage(); // Initialize Storage
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'maintenance-invoicer';

        // --- GLOBAL DATA HELPER ---
        const getCollectionRef = (collectionName) => {
            return db.collection('artifacts').doc(appId).collection('public').doc('data').collection(collectionName);
        };

        // --- HELPER: Timeout Promise for preventing hangs ---
        const timeoutPromise = (ms, promise) => {
            return new Promise((resolve, reject) => {
                const timeoutId = setTimeout(() => {
                    reject(new Error("Operation timed out. Please check your internet connection or if the Firestore API is enabled."));
                }, ms);
                promise.then(
                    (res) => {
                        clearTimeout(timeoutId);
                        resolve(res);
                    },
                    (err) => {
                        clearTimeout(timeoutId);
                        reject(err);
                    }
                );
            });
        };

        // --- CONSTANTS ---
        const PREDEFINED_SERVICES_DEFAULTS = [
            { id: 'custom', label: 'Custom Item...', description: '', rate: 0 },
            { id: 'callout', label: 'Call Out Fee (Standard)', description: 'Standard Call Out Fee', rate: 550 },
            { id: 'callout_ah', label: 'Call Out Fee (After Hours)', description: 'Emergency / After Hours Call Out', rate: 850 },
            { id: 'labor_gen', label: 'Labour (General)', description: 'General Maintenance Labour', rate: 450 },
            { id: 'labor_special', label: 'Labour (Specialist)', description: 'Specialist / Technical Labour', rate: 650 },
            { id: 'fuel', label: 'Fuel / Travel Costs', description: 'Travel & Fuel Charges', rate: 8.50 },
            { id: 'consumables', label: 'Small Consumables', description: 'Fixings, Sealants & Consumables', rate: 150 },
        ];

        const generateId = () => Math.random().toString(36).substr(2, 9);

        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-ZA', {
                style: 'currency',
                currency: 'ZAR',
                minimumFractionDigits: 2
            }).format(amount);
        };

        const formatDate = (dateString) => {
            if (!dateString) return '';
            // Parse YYYY-MM-DD manually to avoid UTC conversion shifts
            const parts = dateString.split('-');
            if (parts.length === 3) {
                const d = new Date(parts[0], parts[1] - 1, parts[2]);
                return d.toLocaleDateString('en-ZA', { year: 'numeric', month: 'long', day: 'numeric' });
            }
            return new Date(dateString).toLocaleDateString('en-ZA', { year: 'numeric', month: 'long', day: 'numeric' });
        };

        const calculateTotals = (items, discountVal, discountType, taxRate, deposit = 0) => {
            const subtotal = items.reduce((acc, item) => acc + (item.quantity * item.rate), 0);
            const totalCost = items.reduce((acc, item) => acc + (item.quantity * (item.cost || 0)), 0);
            
            let discountAmount = discountType === 'percent' ? subtotal * (discountVal / 100) : discountVal;
            discountAmount = Math.min(discountAmount, subtotal);
            const subtotalAfterDiscount = subtotal - discountAmount;
            const taxAmount = subtotalAfterDiscount * (taxRate / 100);
            const total = subtotalAfterDiscount + taxAmount;
            
            const profit = subtotalAfterDiscount - totalCost;
            const margin = subtotalAfterDiscount > 0 ? (profit / subtotalAfterDiscount) * 100 : 0;

            return { subtotal, discountAmount, taxAmount, total, balanceDue: total - deposit, depositRequired60: total * 0.60, totalCost, profit, margin };
        };

        // --- COMPONENTS ---
        const Button = ({ children, variant = 'primary', className, ...props }) => {
            const variants = {
                primary: "bg-blue-600 text-white hover:bg-blue-700 shadow-sm",
                secondary: "bg-white text-slate-700 border border-slate-300 hover:bg-slate-50 shadow-sm",
                danger: "bg-red-50 text-red-600 border border-red-200 hover:bg-red-100",
                ghost: "text-slate-600 hover:bg-slate-100",
                success: "bg-emerald-600 text-white hover:bg-emerald-700 shadow-sm",
                warning: "bg-amber-500 text-white hover:bg-amber-600 shadow-sm",
            };
            return <button className={`px-4 py-2 rounded-lg font-medium transition-all flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed ${variants[variant]} ${className || ''}`} {...props}>{children}</button>;
        };

        const Input = ({ label, error, className, ...props }) => (
            <div className={`flex flex-col gap-1.5 ${className || ''}`}>
                {label && <label className="text-sm font-semibold text-slate-700">{label}</label>}
                <input className={`px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all ${error ? "border-red-300 bg-red-50" : "border-slate-300 bg-white"}`} {...props} />
            </div>
        );

        const Badge = ({ status }) => {
            const styles = {
                Draft: "bg-slate-100 text-slate-600 border-slate-200", Quote: "bg-indigo-50 text-indigo-700 border-indigo-200",
                Pending: "bg-amber-50 text-amber-700 border-amber-200", Paid: "bg-emerald-50 text-emerald-700 border-emerald-200",
                Overdue: "bg-red-50 text-red-700 border-red-200", Deposit: "bg-purple-50 text-purple-700 border-purple-200",
            };
            const icons = { Draft: Icons.FileText, Quote: Icons.FileAxis3d, Pending: Icons.Clock, Paid: Icons.CheckCircle, Overdue: Icons.AlertCircle, Deposit: Icons.CreditCard };
            const IconComp = icons[status] || Icons.FileText;
            return <span className={`px-2.5 py-0.5 rounded-full text-xs font-medium border flex items-center gap-1.5 w-fit ${styles[status] || styles.Draft}`}><IconComp width="12" height="12" />{status}</span>;
        };

        // Custom Searchable Dropdown
        const ClientSelect = ({ clients, value, onSelect }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [search, setSearch] = useState('');
            const wrapperRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [wrapperRef]);

            const filteredClients = clients.filter(c => 
                c.name.toLowerCase().includes(search.toLowerCase())
            );

            return (
                <div className="relative" ref={wrapperRef}>
                    <div 
                        className="w-full p-2 border rounded bg-white flex justify-between items-center cursor-pointer"
                        onClick={() => setIsOpen(!isOpen)}
                    >
                        <span className={value ? "text-slate-900" : "text-slate-400"}>
                            {value || "Select a Client..."}
                        </span>
                        <Icons.ChevronDown className="w-4 h-4 text-slate-400"/>
                    </div>
                    
                    {isOpen && (
                        <div className="absolute z-10 w-full mt-1 bg-white border rounded-lg shadow-lg max-h-60 overflow-hidden flex flex-col">
                            <div className="p-2 border-b">
                                <input 
                                    className="w-full p-1 border rounded text-sm focus:outline-none focus:border-blue-500"
                                    placeholder="Search..."
                                    value={search}
                                    onChange={(e) => setSearch(e.target.value)}
                                    autoFocus
                                />
                            </div>
                            <div className="overflow-y-auto custom-scroll flex-1">
                                {filteredClients.length === 0 && (
                                    <div className="p-3 text-sm text-slate-400 text-center">No clients found</div>
                                )}
                                {filteredClients.map(client => (
                                    <div 
                                        key={client.id}
                                        className="p-3 text-sm hover:bg-slate-50 cursor-pointer border-b last:border-0"
                                        onClick={() => {
                                            onSelect(client);
                                            setIsOpen(false);
                                            setSearch('');
                                        }}
                                    >
                                        <div className="font-medium text-slate-800">{client.name}</div>
                                        {client.email && <div className="text-xs text-slate-500">{client.email}</div>}
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Revenue Chart Component
        const RevenueChart = ({ invoices }) => {
            const chartRef = useRef(null);
            const canvasRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current) return;

                // Process Data: Last 6 months
                const months = [];
                const revenueData = [];
                const profitData = [];
                
                const today = new Date();
                for (let i = 5; i >= 0; i--) {
                    const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                    const monthKey = d.toLocaleString('default', { month: 'short', year: '2-digit' });
                    months.push(monthKey);
                    
                    // Filter invoices for this month
                    const monthlyInvoices = invoices.filter(inv => {
                        if (inv.status === 'Quote' || inv.status === 'Draft') return false;
                        const invDate = new Date(inv.date);
                        return invDate.getMonth() === d.getMonth() && invDate.getFullYear() === d.getFullYear();
                    });

                    const rev = monthlyInvoices.reduce((sum, inv) => sum + (inv.subtotal || 0), 0);
                    
                    // Calculate profit
                    const profit = monthlyInvoices.reduce((sum, inv) => {
                        const cost = (inv.items || []).reduce((c, item) => c + (item.quantity * (item.cost || 0)), 0);
                        return sum + ((inv.subtotal || 0) - cost);
                    }, 0);

                    revenueData.push(rev);
                    profitData.push(profit);
                }

                if (chartRef.current) chartRef.current.destroy();

                chartRef.current = new Chart(canvasRef.current, {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [
                            { label: 'Revenue', data: revenueData, backgroundColor: '#3b82f6', borderRadius: 4 },
                            { label: 'Profit', data: profitData, backgroundColor: '#10b981', borderRadius: 4 }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } },
                        scales: { y: { beginAtZero: true, grid: { color: '#f1f5f9' } }, x: { grid: { display: false } } }
                    }
                });

                return () => { if(chartRef.current) chartRef.current.destroy(); };
            }, [invoices]);

            return <canvas ref={canvasRef} />;
        };

        // --- MAIN APP ---
        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('dashboard');
            const [invoices, setInvoices] = useState([]);
            const [clients, setClients] = useState([]);
            const [settings, setSettings] = useState(null);
            const [loading, setLoading] = useState(true);
            const [currentInvoice, setCurrentInvoice] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [filter, setFilter] = useState('All');
            const [modal, setModal] = useState({ isOpen: false, title: '', message: '', onConfirm: () => {} });
            const [toast, setToast] = useState({ show: false, message: '', type: 'info' });
            
            // New State for Client Edit
            const [clientForm, setClientForm] = useState({ name: '', email: '', phone: '', address: '' });
            
            // New State for UI Logic
            const [showCosts, setShowCosts] = useState(false);

            const showToast = (message, type = 'info') => {
                setToast({ show: true, message, type });
                setTimeout(() => setToast(prev => ({ ...prev, show: false })), 3000);
            };

            // --- COMPUTED SERVICES WITH CUSTOM RATES ---
            const availableServices = useMemo(() => {
                const rates = settings?.serviceRates || {};
                return PREDEFINED_SERVICES_DEFAULTS.map(service => ({
                    ...service,
                    rate: rates[service.id] !== undefined ? Number(rates[service.id]) : service.rate
                }));
            }, [settings]);

            // --- AUTHENTICATION FIX ---
            useEffect(() => {
                const initAuth = async () => {
                    // 1. Explicitly set persistence
                    try {
                        await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                    } catch (e) {
                        console.error("Persistence error:", e);
                    }

                    // 2. Listen for state changes (This handles restoration AND new logins)
                    auth.onAuthStateChanged(async (u) => {
                        if (u) {
                            // User is signed in (or restored)
                            console.log("User authenticated:", u.uid);
                            setUser(u);
                            setLoading(false);
                        } else {
                            // No user found, create/restore anonymous session
                            console.log("No user found, signing in...");
                            try {
                                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                    await auth.signInWithCustomToken(__initial_auth_token);
                                } else {
                                    // Only sign in anonymously if we are effectively 'logged out'
                                    await auth.signInAnonymously();
                                }
                            } catch (error) {
                                console.error("Sign in error:", error);
                                
                                // Handle specific setup errors gracefully
                                if (error.code === 'auth/configuration-not-found' || error.code === 'auth/admin-restricted-operation') {
                                    showToast("Auth Disabled: Enable Anonymous Auth in Firebase Console", "warning");
                                } else {
                                    showToast("Authentication Failed: Public Mode Active", "error");
                                }
                                
                                // CRITICAL FIX: Stop loading even if auth fails so app is usable
                                setLoading(false);
                            }
                        }
                    });
                };
                
                initAuth();
            }, []);

            useEffect(() => {
                // Modified: Allow data fetching even if user is null (Public Mode)
                // if (!user) return; // Removed strict check to allow public read
                
                // USE PUBLIC COLLECTION REF
                const handleReadError = (err) => {
                    console.error("Read Error:", err);
                    setLoading(false);
                    if (err.code === 'permission-denied') {
                        setModal({
                            isOpen: true,
                            title: "Database Locked",
                            message: "Your database rules are blocking access. Go to Firebase Console > Firestore > Rules and change 'allow read, write: if false;' to 'allow read, write: if true;'",
                            onConfirm: () => {}
                        });
                    }
                };

                const unsubInvoices = getCollectionRef('invoices').onSnapshot(snap => {
                    setInvoices(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0)));
                    setLoading(false);
                }, handleReadError);

                const unsubClients = getCollectionRef('clients').onSnapshot(snap => {
                    setClients(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => a.name.localeCompare(b.name)));
                }, (err) => console.error("Client Read Error:", err));

                const unsubSettings = getCollectionRef('settings').doc('preferences').onSnapshot(doc => {
                    if (doc.exists) setSettings(doc.data());
                }, (err) => console.error("Settings Read Error:", err));

                return () => { unsubInvoices(); unsubClients(); unsubSettings(); };
            }, [user]); // Keep user dependency to re-subscribe if auth status changes

            // --- KEYBOARD SHORTCUTS ---
            useEffect(() => {
                const handleKeyDown = (e) => {
                    // Ctrl/Cmd + S to Save
                    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                        e.preventDefault();
                        if (view === 'editor' && currentInvoice) {
                            saveInvoice();
                        }
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [view, currentInvoice]); 

            // --- HELPER: CLEAN DATA FOR FIRESTORE ---
            const cleanDataForFirestore = (obj) => {
                const newObj = {};
                Object.keys(obj).forEach(key => {
                    const val = obj[key];
                    if (val !== undefined) {
                        if (Array.isArray(val)) {
                            newObj[key] = val.map(item => cleanDataForFirestore(item));
                        } else if (val && typeof val === 'object' && !(val instanceof Date)) {
                             if (val.constructor && val.constructor.name === 'FieldValue') {
                                 newObj[key] = val;
                             } else {
                                newObj[key] = cleanDataForFirestore(val);
                             }
                        } else {
                            newObj[key] = val;
                        }
                    }
                });
                return newObj;
            };

            // --- LOGO UPLOADER HELPER ---
            const processLogo = (file) => {
                return new Promise((resolve, reject) => {
                    if (!file.type.startsWith('image/')) {
                        reject(new Error("File is not an image"));
                        return;
                    }
                    if (file.size > 2 * 1024 * 1024) {
                        reject(new Error("File is too large (Max 2MB)"));
                        return;
                    }

                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (e) => {
                        const img = new Image();
                        img.src = e.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const MAX_WIDTH = 300;
                            const MAX_HEIGHT = 150;
                            let width = img.width;
                            let height = img.height;

                            if (width > height) {
                                if (width > MAX_WIDTH) {
                                    height *= MAX_WIDTH / width;
                                    width = MAX_WIDTH;
                                }
                            } else {
                                if (height > MAX_HEIGHT) {
                                    width *= MAX_HEIGHT / height;
                                    height = MAX_HEIGHT;
                                }
                            }

                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            // Compress to JPEG to save space
                            resolve(canvas.toDataURL('image/jpeg', 0.8));
                        };
                        img.onerror = () => reject(new Error("Failed to load image"));
                    };
                    reader.onerror = () => reject(new Error("Failed to read file"));
                });
            };

            const handleLogoUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    setLoading(true);
                    const base64 = await processLogo(file);
                    setSettings(prev => ({...prev, companyLogo: base64}));
                    showToast("Logo processed! Don't forget to Save Settings.", "success");
                } catch(err) {
                    showToast(err.message, "error");
                } finally {
                    setLoading(false);
                }
            };

            const handleRemoveLogo = () => {
                setSettings(prev => {
                    const next = {...prev};
                    delete next.companyLogo;
                    return next;
                });
                showToast("Logo removed. Click Save Settings.", "info");
            };

            // --- SAVE INVOICE (Manual) ---
            const saveInvoice = async () => {
                if (!user || !currentInvoice) return;
                setLoading(true);
                
                const items = currentInvoice.items || [];
                const discountVal = Number(currentInvoice.discountValue) || 0;
                const discountType = currentInvoice.discountType || 'amount';
                const taxRate = Number(currentInvoice.taxRate) || 0;
                const deposit = Number(currentInvoice.deposit) || 0;
                const { subtotal, total, balanceDue } = calculateTotals(items, discountVal, discountType, taxRate, deposit);
                
                const docData = { 
                    ...currentInvoice,
                    items: items.map(i => ({
                        id: i.id || generateId(),
                        description: i.description || '',
                        quantity: Number(i.quantity)||0, 
                        rate: Number(i.rate)||0,
                        cost: Number(i.cost)||0, 
                        type: i.type || 'labor'
                    })),
                    discountValue: discountVal,
                    discountType: discountType,
                    taxRate: taxRate,
                    deposit: deposit,
                    subtotal, total, balanceDue, 
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp() 
                };
                
                delete docData.id; 
                const cleanData = cleanDataForFirestore(docData);

                try {
                    // USE PUBLIC COLLECTION REF with TIMEOUT
                    const ref = getCollectionRef('invoices');
                    if (currentInvoice.id) {
                        await timeoutPromise(10000, ref.doc(currentInvoice.id).update(cleanData));
                    } else {
                        await timeoutPromise(10000, ref.add({ ...cleanData, createdAt: firebase.firestore.FieldValue.serverTimestamp() }));
                    }
                    
                    // SUCCESS STATE:
                    showToast("Document saved successfully", "success");
                    setView('list'); // Force navigation back to list
                    setCurrentInvoice(null); // Clear current invoice to prevent stale data
                    
                } catch(e) { 
                    console.error("SAVE ERROR:", e); 
                    // Handle specific API error
                    if (e.message.includes("Cloud Firestore API") || e.code === "permission-denied") {
                        setModal({
                            isOpen: true,
                            title: "Setup Required",
                            message: "The Cloud Firestore API is not enabled for your project. Please check your browser console for a link to enable it, or visit the Google Cloud Console.",
                            onConfirm: () => {}
                        });
                    } else {
                        showToast("Error saving: " + e.message, "error"); 
                    }
                } finally {
                    setLoading(false);
                }
            };

            // --- ACTIONS ---
            const handleDuplicateClick = (inv = currentInvoice) => {
                setModal({ isOpen: true, title: 'Duplicate Document', message: 'Create a copy of this document?', onConfirm: () => duplicateDocument(inv) });
            };

            const duplicateDocument = async (sourceInvoice) => {
                if (!user || !sourceInvoice) return;
                setLoading(true);
                try {
                    const newItems = (sourceInvoice.items || []).map(item => ({...item, id: generateId()}));
                    const baseData = {
                        number: `${sourceInvoice.number}-COPY`,
                        status: 'Draft',
                        date: new Date().toISOString().split('T')[0],
                        dueDate: sourceInvoice.dueDate || "",
                        clientName: sourceInvoice.clientName || "",
                        clientEmail: sourceInvoice.clientEmail || "",
                        billingAddress: sourceInvoice.billingAddress || "",
                        workDescription: sourceInvoice.workDescription || "",
                        notes: sourceInvoice.notes || "",
                        bankingDetails: sourceInvoice.bankingDetails || "",
                        discountValue: Number(sourceInvoice.discountValue) || 0,
                        discountType: sourceInvoice.discountType || 'amount',
                        taxRate: Number(sourceInvoice.taxRate) || 15,
                        deposit: 0,
                        items: newItems
                    };
                    const { subtotal, total, balanceDue } = calculateTotals(newItems, baseData.discountValue, baseData.discountType, baseData.taxRate, 0);
                    baseData.subtotal = subtotal; baseData.total = total; baseData.balanceDue = balanceDue;

                    const dbPayload = cleanDataForFirestore({ ...baseData, createdAt: firebase.firestore.FieldValue.serverTimestamp(), updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
                    // USE PUBLIC COLLECTION REF
                    const ref = getCollectionRef('invoices');
                    const docRef = await timeoutPromise(10000, ref.add(dbPayload));
                    setCurrentInvoice({ ...baseData, id: docRef.id, createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() });
                    setView('editor'); 
                    showToast("Duplicated Successfully!", "success");
                } catch(e) { 
                    console.error(e); 
                    if (e.message.includes("Cloud Firestore API") || e.code === "permission-denied") {
                        setModal({ isOpen: true, title: "Setup Required", message: "Cloud Firestore API not enabled. Check console for link.", onConfirm: () => {} });
                    } else {
                        showToast("Failed to duplicate: " + e.message, "error"); 
                    }
                } finally { setLoading(false); }
            };

            const handleConvertClick = () => {
                let newNumber = currentInvoice.number || '';
                if (newNumber.startsWith('QT')) newNumber = newNumber.replace('QT', 'INV');
                else if (!newNumber.startsWith('INV')) newNumber = `INV-${newNumber}`;
                setModal({ isOpen: true, title: 'Convert to Invoice', message: `Convert to Invoice ${newNumber}?`, onConfirm: () => convertToInvoice(newNumber) });
            };

            const convertToInvoice = async (newNumber) => {
                if (!user || !currentInvoice) return;
                const quoteIdToDelete = currentInvoice.id;
                setLoading(true);
                try {
                    // Use invoice default notes when converting
                    const defaultInvoiceNotes = settings?.invoiceNotes || 'Thank you for your business! Payment is due within 14 days.';
                    
                    const newItems = (currentInvoice.items || []).map(item => ({...item, id: generateId()}));
                    const baseData = {
                        number: newNumber,
                        status: 'Draft',
                        date: new Date().toISOString().split('T')[0],
                        dueDate: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], 
                        clientName: currentInvoice.clientName || "",
                        clientEmail: currentInvoice.clientEmail || "",
                        billingAddress: currentInvoice.billingAddress || "",
                        workDescription: currentInvoice.workDescription || "",
                        notes: defaultInvoiceNotes, // Apply Invoice Specific Notes
                        bankingDetails: currentInvoice.bankingDetails || (settings?.bankingDetails || ""),
                        discountValue: Number(currentInvoice.discountValue) || 0,
                        discountType: currentInvoice.discountType || 'amount',
                        taxRate: Number(currentInvoice.taxRate) || 15,
                        deposit: 0,
                        items: newItems
                    };
                    const { subtotal, total, balanceDue } = calculateTotals(newItems, baseData.discountValue, baseData.discountType, baseData.taxRate, 0);
                    baseData.subtotal = subtotal; baseData.total = total; baseData.balanceDue = balanceDue;

                    const dbPayload = cleanDataForFirestore({ ...baseData, createdAt: firebase.firestore.FieldValue.serverTimestamp(), updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
                    // USE PUBLIC COLLECTION REF
                    const ref = getCollectionRef('invoices');
                    const docRef = await timeoutPromise(10000, ref.add(dbPayload));
                    if (quoteIdToDelete) { await ref.doc(quoteIdToDelete).delete(); }
                    setCurrentInvoice({ ...baseData, id: docRef.id, createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() });
                    showToast("Converted & Quote Deleted!", "success");
                } catch(e) { console.error(e); showToast("Failed to convert: " + e.message, "error"); } finally { setLoading(false); }
            };

            const updateStatus = async (id, newStatus) => {
                if (!user) return;
                try {
                     // USE PUBLIC COLLECTION REF
                     await getCollectionRef('invoices').doc(id).update({
                        status: newStatus,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                     });
                     showToast(`Status updated to ${newStatus}`, "success");
                } catch(e) {
                    console.error(e);
                    showToast("Failed to update status", "error");
                }
            };

            const deleteDocHandler = async (id, collectionName = 'invoices') => {
                setModal({
                    isOpen: true, title: 'Delete Item', message: 'Are you sure?',
                    onConfirm: async () => {
                        setLoading(true);
                        try {
                            // USE PUBLIC COLLECTION REF
                            await timeoutPromise(10000, getCollectionRef(collectionName).doc(id).delete());
                            
                            // If we are deleting an invoice, always go back to list to prevent showing deleted data
                            if(collectionName === 'invoices') {
                                setView('list');
                                setCurrentInvoice(null);
                            }
                            showToast("Deleted successfully", "success");
                        } catch(e) { console.error(e); showToast("Error deleting: " + e.message, "error"); }
                        finally { setLoading(false); }
                    }
                });
            }

            const saveClient = async () => {
                try {
                    // USE PUBLIC COLLECTION REF
                    const ref = getCollectionRef('clients');
                    if (clientForm.id) {
                        await ref.doc(clientForm.id).update(clientForm);
                        showToast("Client updated", "success");
                    } else {
                        await ref.add({ ...clientForm, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                        showToast("Client added", "success");
                    }
                    // Reset Form
                    setClientForm({ name: '', email: '', phone: '', address: '' });
                } catch(e) { console.error(e); showToast("Error saving client", "error"); }
            };

            const editClient = (client) => {
                setClientForm(client);
                window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to top to see form
            };

            const saveSettingsHandler = async (data) => {
                try {
                    // USE PUBLIC COLLECTION REF
                    await getCollectionRef('settings').doc('preferences').set(data);
                    showToast("Settings Saved", "success");
                } catch(e) { console.error(e); showToast("Error saving settings", "error"); }
            };

            // NEW: Export Data Function
            const exportData = async () => {
                if(!user) return;
                setLoading(true);
                try {
                    const data = { invoices, clients, settings };
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `maint_invoicer_backup_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    showToast("Backup downloaded", "success");
                } catch(e) { console.error(e); showToast("Backup failed", "error"); }
                setLoading(false);
            };

            const createNew = (type) => {
                const isQuote = type === 'quote';
                const prefix = isQuote ? 'QT-' : 'INV-';
                const num = String(invoices.length + 1).padStart(4, '0');
                const calloutService = availableServices.find(s => s.id === 'callout');
                const defaultRate = isQuote ? 0 : (calloutService ? calloutService.rate : 550);

                // Use specific notes based on type
                const defaultNotes = isQuote 
                    ? (settings?.quoteNotes || 'This quote is valid for 30 days. We look forward to working with you!')
                    : (settings?.invoiceNotes || 'Thank you for your business! Payment is due within 14 days.');
                
                const defaultBanking = settings?.bankingDetails || 'Bank Name: \nAccount Holder: \nAccount Number: \nBranch Code: \nReference: ';

                const newItem = {
                    number: `${prefix}${num}`,
                    status: isQuote ? 'Quote' : 'Draft',
                    date: new Date().toISOString().split('T')[0],
                    dueDate: new Date(Date.now() + (isQuote ? 30 : 14) * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    clientName: '', clientEmail: '', billingAddress: '', workDescription: '',
                    items: [{ id: generateId(), description: isQuote ? 'Labor Estimate' : 'Call Out Fee', type: 'labor', quantity: 1, rate: defaultRate, cost: 0 }],
                    notes: defaultNotes,
                    bankingDetails: defaultBanking,
                    subtotal: 0, discountValue: 0, discountType: 'amount', taxRate: 15, deposit: 0, total: 0
                };
                setCurrentInvoice(newItem);
                setView('editor');
            };

            // Filtering
            const filteredInvoices = invoices.filter(inv => {
                const match = inv.clientName?.toLowerCase().includes(searchTerm.toLowerCase()) || inv.number?.toLowerCase().includes(searchTerm.toLowerCase());
                if (!match) return false;
                if (filter === 'Quote') return inv.status === 'Quote';
                if (filter === 'Paid') return inv.status === 'Paid';
                if (filter === 'Unpaid') return (inv.status === 'Pending' || inv.status === 'Overdue' || inv.status === 'Draft');
                return true;
            });

            // Metrics
            const metrics = useMemo(() => {
                const revInvs = invoices.filter(i => i.status !== 'Quote');
                return {
                    revenue: revInvs.reduce((a, b) => a + (b.total || 0), 0),
                    outstanding: revInvs.filter(i => i.status === 'Pending' || i.status === 'Overdue').reduce((a, b) => a + (b.balanceDue ?? b.total), 0),
                    potential: invoices.filter(i => i.status === 'Quote').reduce((a, b) => a + (b.total || 0), 0),
                    completed: revInvs.filter(i => i.status === 'Paid').length
                };
            }, [invoices]);

            // --- VIEWS ---
            if (view === 'preview') {
                const { subtotal, discountAmount, taxAmount, total, balanceDue, depositRequired60 } = calculateTotals(currentInvoice.items, currentInvoice.discountValue, currentInvoice.discountType, currentInvoice.taxRate, currentInvoice.deposit);
                const isQuote = currentInvoice.status === 'Quote';
                const isOverdue = currentInvoice.status === 'Overdue' || (currentInvoice.status === 'Pending' && new Date(currentInvoice.dueDate) < new Date());
                
                // --- FIX: Raw Subject vs Encoded Subject ---
                const rawSubject = (isQuote ? settings?.quoteEmailSubject : settings?.invoiceEmailSubject)
                    ?.replace('{number}', currentInvoice.number)
                    ?.replace('{companyName}', settings?.companyName || 'Maintenance Services') 
                    || `${isQuote ? 'Quote' : 'Invoice'} ${currentInvoice.number}`;
                
                const subject = encodeURIComponent(rawSubject);

                // --- FIX: Improved Default Bodies ---
                const defaultQuoteBody = `Dear {clientName},\n\nThank you for the opportunity to quote on your project.\n\nPlease find the attached quote {number} for your review.\n\nThe total amount is {total}, valid until {dueDate}.\n\nIf you have any questions or would like to proceed, please don't hesitate to contact us.\n\nBest regards,\n{companyName}`;
                
                const defaultInvoiceBody = `Dear {clientName},\n\nI hope you are well.\n\nPlease find attached invoice {number} for the recent work completed.\n\nThe total due is {total}, with payment due by {dueDate}.\n\nOur banking details are included on the invoice document for your convenience.\n\nThank you for your business!\n\nKind regards,\n{companyName}`;

                const rawBody = (isQuote ? (settings?.quoteEmailBody || defaultQuoteBody) : (settings?.invoiceEmailBody || defaultInvoiceBody));
                
                const getProcessedBody = (template) => {
                    return template
                        .replace(/{clientName}/g, currentInvoice.clientName || 'Client')
                        .replace(/{number}/g, currentInvoice.number)
                        .replace(/{total}/g, formatCurrency(total))
                        .replace(/{dueDate}/g, formatDate(currentInvoice.dueDate))
                        .replace(/{companyName}/g, settings?.companyName || 'Maintenance Services');
                };

                // MODIFIED: SHARE FUNCTION (No Cloud Upload)
                const handleShareClick = async () => {
                    const element = document.getElementById('print-container');
                    setLoading(true);

                    try {
                        // 1. Generate PDF Blob
                        const pdfBlob = await html2pdf().from(element).output('blob');
                        const filename = `${isQuote ? 'Quote' : 'Invoice'}_${currentInvoice.number}.pdf`;
                        const pdfFile = new File([pdfBlob], filename, { type: 'application/pdf' });

                        // 2. Prepare Data
                        const email = currentInvoice.clientEmail || '';
                        const subjectText = rawSubject;
                        const bodyText = getProcessedBody(rawBody);

                        // 3. COPY EMAIL TO CLIPBOARD (User Request)
                        if (email) {
                            try {
                                await navigator.clipboard.writeText(email);
                                showToast("Client email copied to clipboard!", "success");
                            } catch (err) {
                                console.error("Clipboard failed", err);
                            }
                        }

                        // 4. Try Web Share API with File
                        if (navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
                            await navigator.share({
                                files: [pdfFile],
                                title: subjectText,
                                text: bodyText
                            });
                        } else {
                            // 5. Fallback: Download + Mailto
                            const link = document.createElement('a');
                            link.href = URL.createObjectURL(pdfBlob);
                            link.download = filename;
                            link.click();

                            // Open mailto link
                            const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subjectText)}&body=${encodeURIComponent(bodyText)}`;
                            window.location.href = mailtoLink;
                            
                            showToast("PDF Downloaded. Email copied. Please attach PDF manually.", "warning");
                        }

                    } catch (err) {
                        console.error(err);
                        // AbortError is common when user cancels share, don't show error toast for that
                        if (err.name !== 'AbortError') {
                            showToast("Error sharing: " + err.message, "error");
                        }
                    } finally {
                        setLoading(false);
                    }
                };

                const handleDownloadPDF = () => {
                    const element = document.getElementById('print-container');
                    const opt = {
                        margin: [10, 10],
                        filename: `${isQuote ? 'Quote' : 'Invoice'}_${currentInvoice.number}.pdf`,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2 },
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                    };
                    html2pdf().set(opt).from(element).save();
                };

                return (
                    <div className="flex flex-col h-screen bg-slate-800">
                        <div className="bg-slate-900 text-white p-4 flex justify-between items-center no-print">
                            <Button variant="ghost" onClick={() => setView('editor')} className="text-slate-300"><Icons.ChevronLeft className="w-4 h-4 mr-2"/> Back</Button>
                            <div className="flex gap-2">
                                <Button variant="secondary" onClick={handleDownloadPDF}><Icons.Download className="w-4 h-4 mr-2"/> PDF</Button>
                                {/* NEW: Share Button */}
                                <Button variant="secondary" onClick={handleShareClick} title="Share PDF via App"><Icons.Send className="w-4 h-4 mr-2"/> Share / Email</Button>
                                <Button variant="primary" onClick={() => window.print()}><Icons.Printer className="w-4 h-4 mr-2"/> Print</Button>
                            </div>
                        </div>
                        <div className="flex-1 overflow-auto p-8 bg-slate-800 print:p-0 print:bg-white flex justify-center">
                            <div id="print-container" className="bg-white w-full max-w-[210mm] min-h-[297mm] p-[20mm] shadow-2xl print:shadow-none print:w-full">
                                <div className="flex justify-between items-start mb-12">
                                    <div className="flex flex-col">
                                        {/* LOGO DISPLAY */}
                                        {settings?.companyLogo ? (
                                            <img src={settings.companyLogo} alt="Logo" className="h-20 w-auto object-contain mb-4 self-start" />
                                        ) : null}
                                        <h1 className="text-4xl font-bold text-slate-900 leading-none">{isQuote ? 'QUOTE' : 'INVOICE'}</h1>
                                        <p className="text-slate-500 text-lg">#{currentInvoice.number}</p>
                                    </div>
                                    <div className="text-right">
                                        <h2 className="font-bold text-xl">{settings?.companyName || 'Maintenance Services'}</h2>
                                        <p className="text-slate-500 text-sm whitespace-pre-line">{settings?.companyAddress}</p>
                                        <p className="text-slate-500 text-sm">{settings?.companyEmail}</p>
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-12 mb-8">
                                    <div><h3 className="text-xs font-bold text-slate-400 uppercase mb-2">Bill To</h3><p className="font-bold">{currentInvoice.clientName}</p><p className="text-slate-600 whitespace-pre-line">{currentInvoice.billingAddress}</p></div>
                                    <div><div className="flex justify-between mb-2"><span className="font-bold text-slate-600">Date:</span><span>{formatDate(currentInvoice.date)}</span></div><div className="flex justify-between"><span className="font-bold text-slate-600">{isQuote ? 'Valid Until:' : 'Due Date:'}</span><span>{formatDate(currentInvoice.dueDate)}</span></div></div>
                                </div>
                                <table className="w-full mb-8">
                                    <thead><tr className="border-b-2 border-slate-800 text-left"><th className="py-2">Description</th><th className="text-center">Qty</th><th className="text-right">Rate</th><th className="text-right">Amount</th></tr></thead>
                                    <tbody>
                                        {currentInvoice.workDescription && <tr className="border-b border-slate-100"><td colSpan="4" className="py-4 text-slate-700 whitespace-pre-wrap italic">{currentInvoice.workDescription}</td></tr>}
                                        {currentInvoice.items.map(item => (<tr key={item.id} className="border-b border-slate-100"><td className="py-4">{item.description}</td><td className="py-4 text-center">{item.quantity}</td><td className="py-4 text-right">{formatCurrency(item.rate)}</td><td className="py-4 text-right font-bold">{formatCurrency(item.quantity * item.rate)}</td></tr>))}
                                    </tbody>
                                </table>
                                <div className="flex justify-end">
                                    <div className="w-64 space-y-2">
                                        <div className="flex justify-between"><span>Subtotal</span><span>{formatCurrency(subtotal)}</span></div>
                                        {discountAmount > 0 && <div className="flex justify-between text-red-500"><span>Discount</span><span>-{formatCurrency(discountAmount)}</span></div>}
                                        <div className="flex justify-between"><span>VAT ({currentInvoice.taxRate}%)</span><span>{formatCurrency(taxAmount)}</span></div>
                                        <div className="flex justify-between font-bold text-lg border-t border-slate-800 pt-2"><span>Total</span><span>{formatCurrency(total)}</span></div>
                                        <div className="flex justify-between text-indigo-600 font-bold pt-2 border-t border-indigo-100"><span>Req. Deposit (60%)</span><span>{formatCurrency(depositRequired60)}</span></div>
                                        {!isQuote && currentInvoice.deposit > 0 && <div className="flex justify-between pt-2 border-t border-slate-200"><span>Paid</span><span>-{formatCurrency(currentInvoice.deposit)}</span></div>}
                                    </div>
                                </div>
                                <div className="mt-12 pt-8 border-t border-slate-100 grid grid-cols-2 gap-8">
                                    <div>
                                        <h4 className="font-bold mb-2">Notes & Terms</h4>
                                        <p className="text-sm text-slate-600 whitespace-pre-wrap">{currentInvoice.notes}</p>
                                    </div>
                                    <div>
                                        {currentInvoice.bankingDetails && (
                                            <div className="bg-slate-50 p-4 rounded-lg border border-slate-200">
                                                <h4 className="font-bold mb-2 text-slate-800 flex items-center gap-2"><Icons.Bank className="w-4 h-4"/> Banking Details</h4>
                                                <p className="text-sm text-slate-600 whitespace-pre-wrap font-mono">{currentInvoice.bankingDetails}</p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex h-screen overflow-hidden relative">
                    <aside className="w-64 bg-slate-900 text-slate-300 flex flex-col no-print">
                        <div className="p-6 font-bold text-white text-xl flex items-center gap-2"><Icons.Wrench/> MaintInvoicer</div>
                        <nav className="flex-1 px-4 space-y-2">
                            {['dashboard','list','reminders','clients','settings'].map(v => (<button key={v} onClick={() => setView(v)} className={`w-full flex items-center p-3 rounded-lg capitalize ${view === v ? 'bg-blue-600 text-white' : 'hover:bg-slate-800'}`}>{v === 'reminders' ? <span className="flex items-center gap-2"><Icons.MailWarning className="w-4 h-4"/> Reminders</span> : v}</button>))}
                        </nav>
                        {user && (
                            <div className="p-4 border-t border-slate-800">
                                <div className="text-xs text-slate-500 mb-1">Status:</div>
                                <div className="text-xs font-mono text-emerald-400 truncate flex items-center gap-2">
                                    <div className="w-2 h-2 bg-emerald-500 rounded-full"></div>
                                    Connected to Cloud
                                </div>
                            </div>
                        )}
                    </aside>
                    <main className="flex-1 overflow-auto p-8 relative z-0">
                        {view === 'dashboard' && (
                            <div className="space-y-6">
                                <div className="flex justify-between items-center"><h1 className="text-2xl font-bold">Dashboard</h1><div className="flex gap-2"><Button onClick={() => createNew('quote')} variant="secondary"><Icons.FileAxis3d className="w-4 h-4 mr-2"/> New Quote</Button><Button onClick={() => createNew('invoice')}><Icons.Plus className="w-4 h-4 mr-2"/> New Invoice</Button></div></div>
                                <div className="grid grid-cols-4 gap-4">
                                    <div className="bg-white p-6 rounded-xl border shadow-sm"><span className="text-sm text-slate-500">Revenue</span><div className="text-2xl font-bold">{formatCurrency(metrics.revenue)}</div></div>
                                    <div className="bg-white p-6 rounded-xl border shadow-sm"><span className="text-sm text-slate-500">Outstanding</span><div className="text-2xl font-bold text-amber-600">{formatCurrency(metrics.outstanding)}</div></div>
                                    <div className="bg-white p-6 rounded-xl border shadow-sm"><span className="text-sm text-slate-500">Potential (Quotes)</span><div className="text-2xl font-bold text-indigo-600">{formatCurrency(metrics.potential)}</div></div>
                                    <div className="bg-white p-6 rounded-xl border shadow-sm"><span className="text-sm text-slate-500">Paid Invoices</span><div className="text-2xl font-bold text-emerald-600">{metrics.completed}</div></div>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div className="bg-white p-6 rounded-xl border shadow-sm h-80">
                                        <h3 className="font-bold text-slate-700 mb-4">Financial Performance (6 Months)</h3>
                                        <div className="h-64"><RevenueChart invoices={invoices} /></div>
                                    </div>
                                    {/* Recent Activity List */}
                                    <div className="bg-white p-6 rounded-xl border shadow-sm h-80 overflow-y-auto custom-scroll">
                                        <h3 className="font-bold text-slate-700 mb-4">Recent Activity</h3>
                                        <div className="space-y-3">
                                            {invoices.slice(0, 6).map(inv => (
                                                <div key={inv.id} className="flex justify-between items-center p-3 hover:bg-slate-50 rounded-lg cursor-pointer border border-transparent hover:border-slate-100 transition-colors" onClick={() => { setCurrentInvoice(inv); setView('editor'); }}>
                                                    <div className="flex items-center gap-3">
                                                        <div className={`p-2 rounded-lg ${inv.status === 'Quote' ? 'bg-indigo-50 text-indigo-600' : 'bg-blue-50 text-blue-600'}`}>
                                                            {inv.status === 'Quote' ? <Icons.FileAxis3d className="w-4 h-4" /> : <Icons.FileText className="w-4 h-4" />}
                                                        </div>
                                                        <div>
                                                            <div className="font-medium text-sm">{inv.number}</div>
                                                            <div className="text-xs text-slate-400">{inv.clientName || 'Unknown Client'}</div>
                                                        </div>
                                                    </div>
                                                    <div className="text-right">
                                                        <div className="font-bold text-sm">{formatCurrency(inv.total)}</div>
                                                        <Badge status={inv.status} />
                                                    </div>
                                                </div>
                                            ))}
                                            {invoices.length === 0 && <p className="text-slate-400 text-sm text-center py-4">No recent activity.</p>}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                        {view === 'list' && (
                            <div className="space-y-6">
                                <div className="flex justify-between"><h1 className="text-2xl font-bold">Documents</h1><Button onClick={() => createNew('invoice')}><Icons.Plus className="w-4 h-4 mr-2"/> Create New</Button></div>
                                <div className="flex gap-4"><input placeholder="Search..." className="border p-2 rounded flex-1" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} /><div className="flex gap-1 bg-slate-100 p-1 rounded">{['All','Quote','Unpaid','Paid'].map(f => (<button key={f} onClick={() => setFilter(f)} className={`px-3 py-1 rounded text-sm ${filter === f ? 'bg-white shadow' : 'text-slate-500'}`}>{f}</button>))}</div></div>
                                <div className="bg-white rounded-xl border shadow-sm overflow-hidden"><table className="w-full text-left"><thead className="bg-slate-50 border-b"><tr><th className="p-4">Number</th><th className="p-4">Client</th><th className="p-4 text-right">Amount</th><th className="p-4 text-center">Status</th><th className="p-4"></th></tr></thead><tbody>{filteredInvoices.map(inv => (<tr key={inv.id} className="hover:bg-slate-50 border-b"><td className="p-4 font-medium">{inv.number}</td><td className="p-4">{inv.clientName}<div className="text-xs text-slate-500">{formatDate(inv.date)}</div></td><td className="p-4 text-right font-bold">{formatCurrency(inv.total)}</td><td className="p-4 text-center"><div className="flex justify-center group relative"><div className="cursor-pointer" onClick={() => { if(inv.status === 'Pending' || inv.status === 'Overdue' || inv.status === 'Draft') updateStatus(inv.id, 'Paid'); }} title="Click to Mark Paid"><Badge status={inv.status}/></div></div></td><td className="p-4 text-right flex justify-end gap-2"><Button variant="ghost" className="p-2" title="Duplicate" onClick={() => handleDuplicateClick(inv)}><Icons.Copy className="w-4 h-4 text-slate-400"/></Button><Button variant="ghost" onClick={() => { setCurrentInvoice(inv); setView('editor'); }}>Edit</Button></td></tr>))}</tbody></table></div>
                            </div>
                        )}
                        {view === 'reminders' && (
                            <div className="space-y-6">
                                <h1 className="text-2xl font-bold">Unpaid Invoices</h1>
                                <div className="bg-white rounded-xl border shadow-sm overflow-hidden">
                                    <table className="w-full text-left">
                                        <thead className="bg-slate-50 border-b">
                                            <tr>
                                                <th className="p-4">Client</th>
                                                <th className="p-4">Invoice #</th>
                                                <th className="p-4">Due Date</th>
                                                <th className="p-4 text-right">Amount Due</th>
                                                <th className="p-4 text-center">Overdue Days</th>
                                                <th className="p-4 text-right">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {invoices
                                                .filter(inv => (inv.status === 'Pending' || inv.status === 'Overdue') && new Date(inv.dueDate) < new Date())
                                                .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate))
                                                .map(inv => {
                                                    const daysOverdue = Math.ceil((new Date() - new Date(inv.dueDate)) / (1000 * 60 * 60 * 24));
                                                    return (
                                                        <tr key={inv.id} className="hover:bg-slate-50 border-b">
                                                            <td className="p-4 font-medium">{inv.clientName}</td>
                                                            <td className="p-4">{inv.number}</td>
                                                            <td className="p-4 text-slate-600">{formatDate(inv.dueDate)}</td>
                                                            <td className="p-4 text-right font-bold text-red-600">{formatCurrency(inv.balanceDue || inv.total)}</td>
                                                            <td className="p-4 text-center"><span className="bg-red-100 text-red-800 text-xs font-bold px-2 py-1 rounded-full">{daysOverdue} Days</span></td>
                                                            <td className="p-4 text-right">
                                                                <a href={`mailto:${inv.clientEmail}?subject=${encodeURIComponent('Overdue Payment: ' + inv.number)}&body=${encodeURIComponent('Dear ' + inv.clientName + ',\n\nThis is a friendly reminder that invoice ' + inv.number + ' is overdue by ' + daysOverdue + ' days.\n\nPlease arrange payment at your earliest convenience.\n\nRegards,\n' + (settings?.companyName || 'Accounts'))}`}>
                                                                    <Button variant="secondary" className="text-xs h-8"><Icons.Bell className="w-3 h-3 mr-2"/> Remind</Button>
                                                                </a>
                                                            </td>
                                                        </tr>
                                                    );
                                                })}
                                            {invoices.filter(inv => (inv.status === 'Pending' || inv.status === 'Overdue') && new Date(inv.dueDate) < new Date()).length === 0 && (
                                                <tr><td colSpan="6" className="p-8 text-center text-slate-500">No overdue invoices found. Great job!</td></tr>
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                        {view === 'clients' && (
                            <div className="space-y-6"><h1 className="text-2xl font-bold">Clients</h1><div className="bg-slate-100 p-4 rounded-lg space-y-2"><h3 className="font-bold">{clientForm.id ? 'Edit Client' : 'Add Client'}</h3><form onSubmit={(e) => { e.preventDefault(); saveClient(); }}><div className="grid grid-cols-2 gap-2"><input name="name" placeholder="Name" className="p-2 border rounded" required value={clientForm.name} onChange={e => setClientForm({...clientForm, name: e.target.value})} /><input name="email" placeholder="Email" className="p-2 border rounded" value={clientForm.email} onChange={e => setClientForm({...clientForm, email: e.target.value})} /><input name="phone" placeholder="Phone" className="p-2 border rounded" value={clientForm.phone} onChange={e => setClientForm({...clientForm, phone: e.target.value})} /><input name="address" placeholder="Address" className="p-2 border rounded" value={clientForm.address} onChange={e => setClientForm({...clientForm, address: e.target.value})} /></div><div className="flex gap-2 mt-2"><Button type="submit">{clientForm.id ? 'Update Client' : 'Save Client'}</Button>{clientForm.id && <Button type="button" variant="secondary" onClick={() => setClientForm({ name: '', email: '', phone: '', address: '' })}>Cancel</Button>}</div></form></div><div className="bg-white rounded-xl border">{clients.map(c => (<div key={c.id} className="p-4 border-b flex justify-between items-center"><div><div className="font-bold">{c.name}</div><div className="text-sm text-slate-500">{c.email}</div></div><div className="flex gap-2"><Button variant="secondary" onClick={() => editClient(c)}><Icons.Edit className="w-4 h-4 text-slate-600"/></Button><Button variant="danger" onClick={() => deleteDocHandler(c.id, 'clients')}><Icons.Trash2 className="w-4 h-4"/></Button></div></div>))}</div></div>
                        )}
                        {view === 'settings' && (
                            <div className="max-w-2xl"><h1 className="text-2xl font-bold mb-6">Settings</h1>
                                <div className="bg-white p-6 rounded-xl border shadow-sm space-y-6">
                                    <div>
                                        <h3 className="font-bold text-lg mb-2">Company Details</h3>
                                        {/* LOGO UPLOADER */}
                                        <div className="mb-6 bg-slate-50 p-4 rounded-lg border border-slate-200">
                                            <label className="text-sm font-bold text-slate-700 block mb-2">Company Logo</label>
                                            <div className="flex items-start gap-4">
                                                {settings?.companyLogo ? (
                                                    <div className="relative group">
                                                        <img src={settings.companyLogo} alt="Logo" className="h-20 w-auto object-contain border bg-white rounded" />
                                                        <button onClick={handleRemoveLogo} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                            <Icons.Trash2 className="w-3 h-3" />
                                                        </button>
                                                    </div>
                                                ) : (
                                                    <div className="h-20 w-20 bg-white border border-dashed border-slate-300 rounded flex items-center justify-center text-slate-300">
                                                        <Icons.Image className="w-8 h-8" />
                                                    </div>
                                                )}
                                                <div className="flex-1">
                                                    <input 
                                                        type="file" 
                                                        accept="image/*" 
                                                        onChange={handleLogoUpload} 
                                                        className="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" 
                                                    />
                                                    <p className="text-xs text-slate-400 mt-2">Recommended: PNG or JPG with transparent background. Max 2MB.</p>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="space-y-4"><Input label="Company Name" value={settings?.companyName || ''} onChange={e => setSettings({...settings, companyName: e.target.value})} /><div className="grid grid-cols-2 gap-4"><Input label="Email" value={settings?.companyEmail || ''} onChange={e => setSettings({...settings, companyEmail: e.target.value})} /><Input label="Phone" value={settings?.companyPhone || ''} onChange={e => setSettings({...settings, companyPhone: e.target.value})} /></div><Input label="Address" value={settings?.companyAddress || ''} onChange={e => setSettings({...settings, companyAddress: e.target.value})} /></div>
                                    </div>
                                    <div className="border-t pt-4"><h3 className="font-bold text-lg mb-2">Service Rates</h3><div className="grid grid-cols-1 md:grid-cols-2 gap-4">{PREDEFINED_SERVICES_DEFAULTS.filter(s => s.id !== 'custom').map(service => (<div key={service.id} className="flex flex-col gap-1"><label className="text-xs font-semibold text-slate-600">{service.label}</label><div className="relative"><span className="absolute left-3 top-2 text-slate-400">R</span><input type="number" className="w-full pl-8 p-2 border rounded" placeholder={service.rate} value={settings?.serviceRates?.[service.id] ?? service.rate} onChange={e => setSettings({ ...settings, serviceRates: { ...(settings?.serviceRates || {}), [service.id]: e.target.value } })} /></div></div>))}</div></div>
                                    
                                    <div className="border-t pt-4 space-y-4">
                                        <h3 className="font-bold text-lg">Default Notes & Terms</h3>
                                        <div>
                                            <label className="text-sm font-bold text-slate-700">Default Quote Notes</label>
                                            <textarea className="w-full border p-2 rounded h-20 text-sm" placeholder="This quote is valid for 30 days..." value={settings?.quoteNotes || ''} onChange={e => setSettings({...settings, quoteNotes: e.target.value})} />
                                        </div>
                                        <div>
                                            <label className="text-sm font-bold text-slate-700">Default Invoice Notes</label>
                                            <textarea className="w-full border p-2 rounded h-20 text-sm" placeholder="Thank you for your business..." value={settings?.invoiceNotes || ''} onChange={e => setSettings({...settings, invoiceNotes: e.target.value})} />
                                        </div>
                                        <div>
                                            <label className="text-sm font-bold text-slate-700">Banking Details</label>
                                            <textarea className="w-full border p-2 rounded h-24 text-sm font-mono" placeholder="Bank Name: &#10;Account No: &#10;Branch Code:" value={settings?.bankingDetails || ''} onChange={e => setSettings({...settings, bankingDetails: e.target.value})} />
                                            <p className="text-xs text-slate-400 mt-1">These details will appear on PDF Quotes and Invoices.</p>
                                        </div>
                                    </div>

                                    {/* Email Templates */}
                                    <div className="border-t pt-4 space-y-4">
                                        <h3 className="font-bold text-lg">Email Templates</h3>
                                        <p className="text-xs text-slate-500">Available placeholders: {'{clientName}'}, {'{number}'}, {'{total}'}, {'{dueDate}'}, {'{companyName}'}</p>
                                        
                                        <div className="grid grid-cols-2 gap-4">
                                            <div className="space-y-2">
                                                <label className="text-sm font-bold text-indigo-700">Quote Email</label>
                                                <Input placeholder="Subject: Quote {number}" value={settings?.quoteEmailSubject || ''} onChange={e => setSettings({...settings, quoteEmailSubject: e.target.value})} />
                                                <textarea className="w-full border p-2 rounded h-32 text-sm" placeholder="Body..." value={settings?.quoteEmailBody || ''} onChange={e => setSettings({...settings, quoteEmailBody: e.target.value})} />
                                            </div>
                                            <div className="space-y-2">
                                                <label className="text-sm font-bold text-blue-700">Invoice Email</label>
                                                <Input placeholder="Subject: Invoice {number}" value={settings?.invoiceEmailSubject || ''} onChange={e => setSettings({...settings, invoiceEmailSubject: e.target.value})} />
                                                <textarea className="w-full border p-2 rounded h-32 text-sm" placeholder="Body..." value={settings?.invoiceEmailBody || ''} onChange={e => setSettings({...settings, invoiceEmailBody: e.target.value})} />
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="border-t pt-4">
                                        <h3 className="font-bold text-lg mb-2 text-slate-800">Data Management</h3>
                                        <p className="text-sm text-slate-500 mb-4">Export all your data to a JSON file for backup purposes.</p>
                                        <div className="flex gap-2">
                                            <Button onClick={exportData} variant="secondary">
                                                <Icons.Download className="w-4 h-4 mr-2"/> Export Data Backup
                                            </Button>
                                        </div>
                                    </div>

                                    <Button onClick={() => saveSettingsHandler(settings)}>Save Settings</Button>
                                </div>
                            </div>
                        )}
                        {view === 'editor' && currentInvoice && (
                            <div className="max-w-4xl mx-auto pb-20">
                                <div className="flex justify-between items-center mb-6"><Button variant="ghost" onClick={() => setView('list')}><Icons.ChevronLeft className="w-4 h-4 mr-2"/> Back</Button><div className="flex gap-2">{currentInvoice.status === 'Quote' && currentInvoice.id && <Button variant="success" onClick={handleConvertClick}><Icons.ArrowRight className="w-4 h-4 mr-2"/> Convert to Inv</Button>}{currentInvoice.id && <Button variant="secondary" onClick={() => handleDuplicateClick()}><Icons.Copy className="w-4 h-4 mr-2"/> Duplicate</Button>}<Button variant="secondary" onClick={() => setView('preview')}><Icons.Printer className="w-4 h-4 mr-2"/> Preview</Button><Button onClick={saveInvoice} title="Ctrl + S to Save"><Icons.Save className="w-4 h-4 mr-2"/> Save</Button></div></div>
                                <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                                    <div className="p-6 bg-slate-50 border-b grid grid-cols-3 gap-4"><Input label="Number" value={currentInvoice.number} onChange={e => setCurrentInvoice({...currentInvoice, number: e.target.value})} /><Input type="date" label="Date" value={currentInvoice.date} onChange={e => { const newDate = e.target.value; const dueDate = new Date(new Date(newDate).getTime() + 14 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]; setCurrentInvoice({...currentInvoice, date: newDate, dueDate: dueDate}); }} /><div><label className="text-sm font-bold">Status</label><select className="w-full p-2 border rounded" value={currentInvoice.status} onChange={e => setCurrentInvoice({...currentInvoice, status: e.target.value})}>{['Draft','Quote','Pending','Paid','Overdue'].map(s => <option key={s} value={s}>{s}</option>)}</select></div></div>
                                    <div className="p-6 space-y-4">
                                        <div className="grid grid-cols-2 gap-6">
                                            <div className="space-y-2">
                                                <label className="text-sm font-bold">Client</label>
                                                <ClientSelect 
                                                    clients={clients} 
                                                    value={currentInvoice.clientName} 
                                                    onSelect={(c) => setCurrentInvoice({...currentInvoice, clientName: c.name, clientEmail: c.email, billingAddress: c.address})} 
                                                />
                                                <Input placeholder="Email" value={currentInvoice.clientEmail} onChange={e => setCurrentInvoice({...currentInvoice, clientEmail: e.target.value})} /><textarea placeholder="Billing Address" className="w-full p-2 border rounded h-20" value={currentInvoice.billingAddress} onChange={e => setCurrentInvoice({...currentInvoice, billingAddress: e.target.value})} />
                                            </div>
                                            <div className="space-y-2"><label className="text-sm font-bold">Job Details</label><textarea placeholder="Work Description (Scope of Work)" className="w-full p-2 border rounded h-20" value={currentInvoice.workDescription} onChange={e => setCurrentInvoice({...currentInvoice, workDescription: e.target.value})} /><Input type="date" label="Due Date" value={currentInvoice.dueDate} onChange={e => setCurrentInvoice({...currentInvoice, dueDate: e.target.value})} /></div>
                                        </div>
                                        <div className="border-t pt-4">
                                            <div className="flex justify-between items-center mb-4">
                                                <h3 className="font-bold text-slate-800">Items & Charges</h3>
                                                <div className="flex items-center gap-2"><span className="text-sm text-slate-500">Show Costs (Profit)</span><button onClick={() => setShowCosts(!showCosts)} className={`w-10 h-6 rounded-full p-1 transition-colors ${showCosts ? 'bg-blue-600' : 'bg-slate-300'}`}><div className={`w-4 h-4 bg-white rounded-full shadow-md transform transition-transform ${showCosts ? 'translate-x-4' : 'translate-x-0'}`}></div></button></div>
                                            </div>
                                            <div className="space-y-3">{currentInvoice.items.map((item, idx) => (<div key={item.id} className="flex flex-col md:flex-row gap-2 items-start bg-slate-50 p-3 rounded-lg border border-slate-200"><div className="flex-1 w-full"><label className="text-[10px] uppercase font-bold text-slate-400 mb-1 block">Item / Service</label><select className="w-full p-2 border rounded bg-white text-slate-700 mb-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" onChange={(e) => { const service = availableServices.find(s => s.id === e.target.value); if (service && service.id !== 'custom') { const newItems = [...currentInvoice.items]; newItems[idx].description = service.description; newItems[idx].rate = service.rate; setCurrentInvoice({...currentInvoice, items: newItems}); } }} defaultValue=""><option value="" disabled>Select a preset...</option>{availableServices.map(s => <option key={s.id} value={s.id}>{s.label}</option>)}</select><input className="w-full p-2 border rounded bg-white focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Description" value={item.description} onChange={e => { const newItems = [...currentInvoice.items]; newItems[idx].description = e.target.value; setCurrentInvoice({...currentInvoice, items: newItems}); }} /></div><div className="flex gap-2 w-full md:w-auto"><div className="w-20"><label className="text-[10px] uppercase font-bold text-slate-400 mb-1 block">Qty</label><input type="number" className="w-full p-2 border rounded bg-white text-center" placeholder="1" value={item.quantity} onChange={e => { const newItems = [...currentInvoice.items]; newItems[idx].quantity = Number(e.target.value); setCurrentInvoice({...currentInvoice, items: newItems}); }} /></div><div className="w-28"><label className="text-[10px] uppercase font-bold text-slate-400 mb-1 block">Rate (R)</label><input type="number" className="w-full p-2 border rounded bg-white text-right" placeholder="0.00" value={item.rate} onChange={e => { const newItems = [...currentInvoice.items]; newItems[idx].rate = Number(e.target.value); setCurrentInvoice({...currentInvoice, items: newItems}); }} /></div>
                                            {showCosts && (<div className="w-24"><label className="text-[10px] uppercase font-bold text-slate-400 mb-1 block text-orange-600">Cost (R)</label><input type="number" className="w-full p-2 border border-orange-200 rounded bg-orange-50 text-right text-orange-800" placeholder="0.00" value={item.cost || 0} onChange={e => { const newItems = [...currentInvoice.items]; newItems[idx].cost = Number(e.target.value); setCurrentInvoice({...currentInvoice, items: newItems}); }} /></div>)}
                                            <div className="pt-6"><Button variant="danger" className="h-[42px]" onClick={() => { const newItems = currentInvoice.items.filter(i => i.id !== item.id); setCurrentInvoice({...currentInvoice, items: newItems}); }}><Icons.Trash2 className="w-4 h-4"/></Button></div></div></div>))}</div><Button variant="secondary" className="mt-4" onClick={() => setCurrentInvoice({...currentInvoice, items: [...currentInvoice.items, { id: generateId(), description: '', quantity: 1, rate: 0, cost: 0 }]})}><Icons.Plus className="w-4 h-4 mr-2"/> Add Line Item</Button></div>
                                        
                                        {/* UPDATED EDITOR FOOTER */}
                                        <div className="border-t pt-4 grid grid-cols-2 gap-8">
                                            <div className="space-y-4">
                                                <div>
                                                    <label className="text-sm font-bold text-slate-700">Notes & Terms</label>
                                                    <textarea className="w-full border p-2 rounded h-24 text-sm" placeholder="Notes..." value={currentInvoice.notes} onChange={e => setCurrentInvoice({...currentInvoice, notes: e.target.value})} />
                                                </div>
                                                <div>
                                                    <label className="text-sm font-bold text-slate-700 flex items-center gap-2"><Icons.Bank className="w-3 h-3"/> Banking Details</label>
                                                    <textarea className="w-full border p-2 rounded h-24 text-sm font-mono" placeholder="Bank details..." value={currentInvoice.bankingDetails || ''} onChange={e => setCurrentInvoice({...currentInvoice, bankingDetails: e.target.value})} />
                                                </div>
                                            </div>
                                            <div className="space-y-2 text-right">
                                                <div className="flex justify-between items-center"><span className="text-sm">Discount</span><input type="number" className="border p-1 rounded w-20 text-right" value={currentInvoice.discountValue} onChange={e => setCurrentInvoice({...currentInvoice, discountValue: Number(e.target.value)})} /></div>
                                                <div className="flex justify-between items-center"><span className="text-sm">Deposit Paid</span><input type="number" className="border p-1 rounded w-20 text-right" value={currentInvoice.deposit} onChange={e => setCurrentInvoice({...currentInvoice, deposit: Number(e.target.value)})} /></div>
                                                <div className="text-xl font-bold">Total: {formatCurrency(calculateTotals(currentInvoice.items, currentInvoice.discountValue, currentInvoice.discountType, currentInvoice.taxRate, currentInvoice.deposit).total)}</div>
                                                {showCosts && (<div className="text-sm text-emerald-600 pt-2 border-t mt-2">Est. Profit: {formatCurrency(calculateTotals(currentInvoice.items, currentInvoice.discountValue, currentInvoice.discountType, currentInvoice.taxRate, currentInvoice.deposit).profit)} ({calculateTotals(currentInvoice.items, currentInvoice.discountValue, currentInvoice.discountType, currentInvoice.taxRate, currentInvoice.deposit).margin.toFixed(1)}%)</div>)}
                                            </div>
                                        </div>
                                    </div>
                                    {currentInvoice.id && (<div className="bg-slate-50 p-4 border-t flex justify-center"><Button variant="danger" onClick={() => deleteDocHandler(currentInvoice.id)}><Icons.Trash2 className="w-4 h-4 mr-2"/> Delete Document</Button></div>)}
                                </div>
                            </div>
                        )}
                    </main>

                    {/* OVERLAYS AT ROOT LEVEL FOR Z-INDEX CORRECTNESS */}
                    {modal.isOpen && (<div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[100] animate-fade-in"><div className="bg-white p-6 rounded-xl shadow-xl max-w-sm w-full mx-4 animate-slide-up"><h3 className="font-bold text-lg mb-2 text-slate-800">{modal.title}</h3><p className="text-slate-600 mb-6">{modal.message}</p><div className="flex justify-end gap-2"><Button variant="secondary" onClick={() => setModal({ ...modal, isOpen: false })}>Cancel</Button><Button onClick={() => { setModal({ ...modal, isOpen: false }); modal.onConfirm(); }}>Confirm</Button></div></div></div>)}
                    {toast.show && (<div className={`fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white font-medium animate-slide-up z-[110] ${toast.type === 'error' ? 'bg-red-600' : 'bg-emerald-600'}`}>{toast.message}</div>)}
                    {loading && (<div className="loading-overlay"><div className="bg-white p-6 rounded-xl shadow-2xl flex flex-col items-center"><div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-2"></div><div>Processing...</div></div></div>)}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
